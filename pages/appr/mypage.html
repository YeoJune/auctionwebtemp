<!-- pages/appr/mypage.html -->
<!-- 마이페이지 -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>마이페이지 - CAS 명품감정시스템</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Montserrat:wght@500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      /* 기본 리셋 및 폰트 설정 (제공해주신 원본 CSS 유지) */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
      }

      body {
        color: #1a2a3a;
        line-height: 1.6;
        background-color: #f8fafc;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* 헤더 & 푸터 공통 스타일 (제공해주신 원본 CSS 유지) */
      header {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 0;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 40px;
      }

      .logo {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1a2a3a;
        text-decoration: none;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
      }

      .logo .cas-highlight {
        background: linear-gradient(135deg, #1a2a3a 0%, #2d4263 100%);
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-desktop {
        display: none;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        justify-content: flex-end;
      }

      .nav-desktop a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        white-space: nowrap;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      .nav-desktop a:hover {
        color: #666;
        background-color: rgba(0, 0, 0, 0.05);
      }

      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .mobile-menu {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: #fff;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      }

      .mobile-menu a {
        display: block;
        padding: 15px 20px;
        color: #4a5568;
        text-decoration: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .mobile-menu a:last-child {
        border-bottom: none;
      }

      @media (min-width: 768px) {
        .nav-desktop {
          display: flex !important;
          gap: 8px;
        }
        .mobile-menu-btn {
          display: none !important;
        }
      }

      @media (min-width: 1024px) {
        .nav-desktop {
          gap: 12px;
        }
        .nav-desktop a {
          padding: 8px 16px;
          font-size: 1rem;
        }
      }

      .btn-primary {
        background-color: #1a2a3a;
        color: #fff;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-primary:hover {
        background-color: #2d4263;
      }

      .btn-outline {
        background-color: transparent;
        color: #1a2a3a;
        padding: 12px 24px;
        border: 1px solid #1a2a3a;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-outline:hover {
        background-color: rgba(26, 42, 58, 0.05);
      }

      /* 탭 메뉴 스타일 (제공해주신 원본 CSS 유지) */
      .tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .tab {
        padding: 12px 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
        border-bottom: 2px solid transparent;
      }

      .tab:hover {
        color: #1a2a3a;
      }

      .tab.active {
        color: #1a2a3a;
        border-bottom-color: #1a2a3a;
      }

      /* 마이페이지 스타일 (제공해주신 원본 CSS 유지) */
      .user-profile {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        gap: 20px;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #64748b;
      }

      .user-info h2 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .user-info p {
        color: #64748b;
      }

      .stats {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        flex: 1;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
      }

      .stat-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card.active {
        border: 2px solid #1a2a3a;
      }

      .stat-card h3 {
        font-size: 1rem;
        color: #64748b;
        margin-bottom: 8px;
      }

      .stat-card .number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1a2a3a;
      }

      .appraisal-list {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .appraisal-item {
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s;
      }

      .appraisal-item:last-child {
        border-bottom: none;
      }

      .appraisal-item:hover {
        background-color: #f1f5f9;
      }

      .appraisal-item-image {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
      }

      .appraisal-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .appraisal-item-content {
        flex: 1;
      }

      .appraisal-item-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .appraisal-item-details {
        font-size: 0.9rem;
        color: #64748b;
      }

      .appraisal-item-action {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #e2e8f0;
        color: #1a2a3a;
        text-decoration: none;
      }

      .appraisal-item-action:hover {
        background-color: #cbd5e1;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 8px;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #059669;
      }
      .badge-error {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .badge-warning {
        background-color: #fef3c7;
        color: #d97706;
      }
      .badge-pending {
        background-color: #e0e7ff;
        color: #4338ca;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 8px;
      }
      .pagination-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
      }
      .pagination-item:hover {
        background-color: #e2e8f0;
      }
      .pagination-item.active {
        background-color: #1a2a3a;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
      }
      .empty-state-icon {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 15px;
      }
      .empty-state-message {
        color: #64748b;
        font-size: 1.1rem;
        margin-bottom: 20px;
      }
      /* 로딩 스피너 (필요시 추가) */
      .loading {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #64748b;
      }
      /* 팝업 스타일 (제공해주신 원본 CSS 유지) */
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; /* 기본 숨김 */
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .popup.show {
        display: flex;
        opacity: 1;
        visibility: visible;
      }
      .popup-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 90%;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #aaa;
      }
      .popup-close:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-inner">
          <div class="header-left">
            <a href="/appr" class="logo">
              <img
                src="https://i.ibb.co/FqJhVh0T/image.png"
                alt="CAS 명품감정시스템"
                style="height: 40px" />
            </a>
            <nav class="nav-desktop">
              <a href="/appr">홈</a>
              <a href="/appr/request">감정신청</a>
              <a href="/appr/result">감정번호조회</a>
              <a href="/appr/mypage">마이페이지</a>
              <a href="/appr/repair">까사복원시스템</a>
              <a href="/appr/authenticity">정가품구별법</a>
              <a href="/appr/signin">로그인</a>
            </nav>
          </div>
          <button
            class="mobile-menu-btn"
            id="menu-icon"
            onclick="toggleMobileMenu()">
            ☰
          </button>
        </div>
      </div>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="/appr">홈</a>
      <a href="/appr/request">감정신청</a>
      <a href="/appr/result">감정번호조회</a>
      <a href="/appr/mypage">마이페이지</a>
      <a href="/appr/repair">까사복원시스템</a>
      <a href="/appr/authenticity">정가품구별법</a>
      <a href="/appr/signin">로그인</a>
    </div>

    <main>
      <section style="padding: 50px 0">
        <div class="container">
          <div class="user-profile">
            <div class="user-avatar" id="user-avatar-initial"></div>
            <div class="user-info">
              <h2 id="user-name-display">로딩 중...</h2>
              <p>가입일: <span id="join-date-display">-</span></p>
            </div>
          </div>

          <div
            style="
              background-color: #fff;
              border-radius: 8px;
              padding: 25px;
              margin-bottom: 30px;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            ">
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 30px;
                align-items: flex-end;
              ">
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  회원등급
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="membership-badge"
                    class="badge badge-pending"
                    style="margin-right: 10px"
                    >정보 없음</span
                  >
                  <a
                    href="#"
                    onclick="showMembershipInfo(); return false;"
                    style="
                      font-size: 0.85rem;
                      color: #64748b;
                      text-decoration: underline;
                    "
                    >등급 혜택 보기</a
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  퀵링크 감정 크레딧
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="quicklink-credit"
                    style="
                      font-size: 1.25rem;
                      font-weight: 700;
                      color: #1a2a3a;
                      margin-right: 5px;
                    "
                    >0회</span
                  >
                  <span
                    id="quicklink-limit"
                    style="color: #64748b; font-size: 0.9rem"
                    >/ 월 0회</span
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  구독 상태
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="subscription-status"
                    class="badge badge-error"
                    style="margin-right: 10px"
                    >미구독</span
                  >
                  <button
                    id="btn-manage-subscription"
                    class="btn-primary"
                    style="padding: 6px 10px; font-size: 0.8rem"
                    onclick="handleSubscriptionAction()">
                    구독 신청하기
                  </button>
                </div>
              </div>
            </div>
            <p
              style="
                font-size: 0.9rem;
                color: #64748b;
                margin-top: 15px;
                border-top: 1px solid #e2e8f0;
                padding-top: 15px;
              ">
              * 퀵링크 감정 크레딧은 매월 1일에 초기화됩니다.<br />
              * 정품 또는 가품으로 판정된 경우에만 크레딧이 차감되며,
              자료부족으로 판정된 경우는 차감되지 않습니다.
            </p>
          </div>

          <div class="stats">
            <div
              class="stat-card active"
              onclick="filterAppraisals('all', this)">
              <h3>총 감정요청</h3>
              <div class="number" id="stat-total-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              onclick="filterAppraisals('pending_review,in_review', this)">
              <h3>감정중</h3>
              <div class="number" id="stat-pending-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              onclick="filterAppraisals('completed', this)">
              <h3>감정완료</h3>
              <div class="number" id="stat-completed-appraisals">0</div>
            </div>
          </div>

          <div class="appraisal-list">
            <div id="appraisal-list-items">
              <div class="loading">감정 내역을 불러오는 중...</div>
            </div>
            <div class="pagination" id="appraisal-pagination"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- 등급 혜택 팝업 (제공해주신 원본 HTML 구조 유지) -->
    <div id="membership-info-popup" class="popup">
      <div class="popup-content">
        <span class="popup-close" onclick="closePopup('membership-info-popup')"
          >✕</span
        >
        <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 20px">
          회원등급 혜택 안내
        </h3>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            까사트레이드 회원
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>퀵링크 감정 구독 무료</li>
            <li>월 10회 퀵링크 감정 제한</li>
            <li>오프라인 실물감정 38,000원 → <strong>12,000원</strong></li>
          </ul>
        </div>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            제휴사 회원
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>퀵링크 감정 구독 무료</li>
            <li>월 5회 퀵링크 감정 제한</li>
            <li>오프라인 실물감정 38,000원 → <strong>20,000원</strong></li>
          </ul>
        </div>
        <div style="margin-bottom: 15px">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            일반회원
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>퀵링크 감정 구독 월 29,000원</li>
            <li>월 10회 퀵링크 감정 제한</li>
            <li>오프라인 실물감정 38,000원</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 나이스페이 JS SDK (실제 결제 시 HEAD나 BODY 끝에 추가) -->
    <!-- <script src="https://pay.nicepay.co.kr/v1/js/"></script> -->

    <script>
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobile-menu");
        const menuIcon = document.getElementById("menu-icon");
        if (mobileMenu.style.display === "block") {
          mobileMenu.style.display = "none";
          if (menuIcon) menuIcon.textContent = "☰";
        } else {
          mobileMenu.style.display = "block";
          if (menuIcon) menuIcon.textContent = "✕";
        }
      }

      function showMembershipInfo() {
        document.getElementById("membership-info-popup").classList.add("show");
        document.body.style.overflow = "hidden";
      }

      function closePopup(popupId) {
        document.getElementById(popupId).classList.remove("show");
        document.body.style.overflow = "";
      }

      let currentAppraisalPage = 1;
      const appraisalsPerPage = 5; // 한 페이지에 표시할 감정 내역 수
      let currentStatusFilter = "all"; // 현재 선택된 감정 상태 필터

      async function fetchMyPageData(page = 1, statusFilter = "all") {
        const appraisalListLoadingEl = document.getElementById(
          "appraisal-list-loading"
        );
        if (appraisalListLoadingEl)
          appraisalListLoadingEl.style.display = "block";

        try {
          let apiUrl = `/api/appr/appraisals/my?page=${page}&limit=${appraisalsPerPage}`;
          // '/my' API는 현재 status 필터링을 지원하지 않으므로,
          // 만약 상태별 필터링된 목록이 필요하면 '/api/appr/appraisals'를 사용하고,
          // 사용자 정보와 멤버십 정보는 별도로 가져오거나, '/my' API를 수정해야 합니다.
          // 여기서는 '/my' API가 모든 정보를 다 준다고 가정하고, 클라이언트에서 필터링합니다.
          // 또는, filterAppraisals 함수에서 직접 /api/appr/appraisals?status=XXX 를 호출하도록 변경합니다.
          // 현재는 /my 에서 받은 전체 목록을 기준으로 클라이언트 필터링합니다.

          const response = await fetch(apiUrl, { credentials: "include" });
          if (!response.ok) {
            if (response.status === 401) window.location.href = "/signinPage";
            throw new Error(
              "마이페이지 정보 로드 실패: " + response.statusText
            );
          }
          const data = await response.json();

          if (data.success) {
            // 사용자 프로필 정보 업데이트
            if (data.user_info) {
              document.getElementById("user-name-display").textContent = `${
                data.user_info.name || "고객"
              }님`;
              document.getElementById("join-date-display").textContent = data
                .user_info.created_at
                ? new Date(data.user_info.created_at).toLocaleDateString()
                : "-"; // API에 created_at 추가 가정
              if (data.user_info.name) {
                document.getElementById("user-avatar-initial").textContent =
                  data.user_info.name.charAt(0);
              } else {
                document.getElementById("user-avatar-initial").textContent =
                  "👤";
              }
            }

            // 멤버십 및 크레딧 정보 업데이트
            if (data.membership_info) {
              const tierBadge = document.getElementById(
                "membership-tier-badge"
              );
              const creditValue = document.getElementById(
                "quicklink-credit-value"
              );
              const creditLimitText = document.getElementById(
                "quicklink-limit-text"
              );
              const subscriptionBadge = document.getElementById(
                "subscription-status-badge"
              );
              const subscriptionButton = document.getElementById(
                "btn-manage-subscription"
              );

              tierBadge.textContent = data.membership_info.tier;
              if (data.membership_info.tier === "까사트레이드 회원")
                tierBadge.className = "membership-badge badge-casatrade";
              else if (data.membership_info.tier === "제휴사 회원")
                tierBadge.className = "membership-badge badge-partner";
              else tierBadge.className = "membership-badge badge-regular";

              creditValue.textContent = `${data.membership_info.quick_link_credits_remaining_this_month}회`;
              creditLimitText.textContent = ` / 월 ${data.membership_info.quick_link_credits_monthly_limit}회`;

              if (data.membership_info.tier === "일반회원") {
                if (
                  data.membership_info.subscription_expires_at &&
                  new Date(data.membership_info.subscription_expires_at) >
                    new Date()
                ) {
                  subscriptionBadge.textContent = "구독중";
                  subscriptionBadge.className =
                    "membership-badge badge-subscribed";
                  subscriptionButton.textContent = "구독 관리";
                  subscriptionButton.onclick = () => {
                    alert("구독 관리 기능은 준비 중입니다.");
                  };
                } else {
                  subscriptionBadge.textContent = "미구독";
                  subscriptionBadge.className =
                    "membership-badge badge-unsubscribed";
                  subscriptionButton.textContent = "구독 신청하기";
                  subscriptionButton.onclick = handleSubscriptionAction;
                }
                subscriptionButton.style.display = "inline-block";
              } else {
                subscriptionBadge.textContent = "혜택 적용중";
                subscriptionBadge.className =
                  "membership-badge badge-subscribed";
                subscriptionButton.style.display = "none";
              }
            }

            // 감정 내역 및 통계 업데이트
            const allAppraisals = data.recent_appraisals.appraisals || [];
            updateAppraisalStats(allAppraisals); // 전체 목록 기준으로 통계 계산
            filterAndRenderAppraisals(
              statusFilter,
              allAppraisals,
              page,
              data.recent_appraisals.pagination
            );
          } else {
            throw new Error(data.message || "데이터 로드 실패");
          }
        } catch (error) {
          console.error(error);
          document.getElementById("user-name-display").textContent = "오류";
          document.getElementById(
            "appraisal-list-items"
          ).innerHTML = `<p style="color:red;">${error.message}</p>`;
        } finally {
          if (appraisalListLoadingEl)
            appraisalListLoadingEl.style.display = "none";
        }
      }

      function updateAppraisalStats(appraisals) {
        let total = 0;
        let pending = 0;
        let completed = 0;

        // `/my` API가 페이지네이션된 최근 목록만 주므로, 정확한 전체 통계는 별도 API 필요.
        // 여기서는 일단 로드된 목록 기준으로만 카운트.
        // 또는 백엔드에서 전체 통계를 같이 내려주도록 수정.
        // 임시로, 백엔드에서 전체 totalItems를 내려준다고 가정하고 사용.
        fetch(`/api/appr/appraisals?limit=1`, { credentials: "include" }) // 전체 개수 파악용
          .then((res) => res.json())
          .then((data) => {
            if (data.success && data.pagination) {
              document.getElementById("stat-total-appraisals").textContent =
                data.pagination.totalItems || 0;
            }
          });

        // 상태별 카운트는 클라이언트에서 필터링 할 때 계산하거나, 백엔드가 제공해야 함.
        // 지금은 로드된 목록 기준으로만 계산 (정확하지 않을 수 있음)
        appraisals.forEach((appr) => {
          if (appr.status === "pending" || appr.status === "in_review")
            pending++;
          if (appr.status === "completed") completed++;
        });
        document.getElementById("stat-pending-appraisals").textContent =
          pending;
        document.getElementById("stat-completed-appraisals").textContent =
          completed;
      }

      function filterAndRenderAppraisals(
        statusFilter,
        allAppraisals,
        currentPage,
        paginationData
      ) {
        let filteredAppraisals = allAppraisals;
        if (statusFilter !== "all") {
          const filterStates = statusFilter.split(",");
          filteredAppraisals = allAppraisals.filter((appr) =>
            filterStates.includes(appr.status)
          );
        }
        // 클라이언트 사이드 필터링 시, 페이지네이션은 전체 목록 기준으로 다시 계산하거나,
        // 서버 사이드 필터링을 사용해야 정확합니다.
        // 현재는 `/my` API가 필터링을 지원하지 않으므로, 클라이언트에서 필터링된 목록만 보여줍니다.
        // 페이지네이션은 서버에서 받은 그대로 사용합니다. (필터 시 페이지네이션이 정확하지 않을 수 있음)
        renderAppraisalList(filteredAppraisals);
        renderPagination(paginationData, statusFilter); // 필터 상태 전달
      }

      function renderAppraisalList(appraisals) {
        const listDiv = document.getElementById("appraisal-list-items");
        listDiv.innerHTML = "";
        if (appraisals && appraisals.length > 0) {
          appraisals.forEach((appr) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "appraisal-item";
            let resultText = appr.status;
            let resultBadgeClass = "badge-pending";
            if (appr.status === "completed") {
              if (appr.result === "authentic") {
                resultText = "정품";
                resultBadgeClass = "badge-success";
              } else if (appr.result === "fake") {
                resultText = "가품";
                resultBadgeClass = "badge-error";
              } else if (appr.result === "uncertain") {
                resultText = "판단불가";
                resultBadgeClass = "badge-warning";
              } else {
                resultText = "완료";
                resultBadgeClass = "badge-success";
              }
            } else if (appr.status === "pending") {
              resultText = "접수완료";
            } else if (appr.status === "in_review") {
              resultText = "감정중";
            } else if (appr.status === "cancelled") {
              resultText = "취소됨";
              resultBadgeClass = "badge-error";
            }

            let detailPageUrl = `/appr/quick-result/${appr.id}`;
            // API 응답에 certificate_number가 포함되어 있다면 아래 주석 해제
            // if (appr.certificate_number) {
            //     detailPageUrl = `/appr/result-detail/${appr.certificate_number}`;
            // }

            itemDiv.innerHTML = `
                        <div class="appraisal-item-image">
                            <img src="${
                              appr.representative_image ||
                              "https://via.placeholder.com/60x60/eee/ccc?text=NoImg"
                            }" alt="상품 이미지">
                        </div>
                        <div class="appraisal-item-content">
                            <div class="appraisal-item-title">${appr.brand} ${
              appr.model_name
            }</div>
                            <div class="appraisal-item-details">
                                신청일: ${new Date(
                                  appr.created_at
                                ).toLocaleDateString()}
                                <span class="badge ${resultBadgeClass}">${resultText.toUpperCase()}</span>
                            </div>
                        </div>
                        ${
                          appr.status === "completed" ||
                          appr.status === "cancelled"
                            ? `<a href="${detailPageUrl}" class="appraisal-item-action">결과 보기</a>`
                            : `<span class="appraisal-item-action" style="cursor:default; background-color:#f1f5f9; color:#64748b;">진행중</span>`
                        }
                    `;
            listDiv.appendChild(itemDiv);
          });
        } else {
          listDiv.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">📋</div><p>해당 조건의 감정 내역이 없습니다.</p></div>';
        }
      }

      function renderPagination(pagination, statusFilterForNextPage) {
        const paginationDiv = document.getElementById("appraisal-pagination");
        paginationDiv.innerHTML = "";
        if (!pagination || pagination.totalPages <= 1) return;

        for (let i = 1; i <= pagination.totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.textContent = i;
          if (i === pagination.currentPage) pageButton.classList.add("active");
          pageButton.onclick = () => {
            currentAppraisalPage = i;
            fetchMyPageData(currentAppraisalPage); // 필터된 목록이 아닌 전체 목록의 페이지를 다시 가져옴
            // 또는 filterAndLoadAppraisals(statusFilterForNextPage, i) 호출
          };
          paginationDiv.appendChild(pageButton);
        }
      }

      document.querySelectorAll(".stat-card").forEach((card, index) => {
        // 첫 번째 카드: 전체, 두 번째 카드: 감정중, 세 번째 카드: 감정완료
        if (index === 0) card.setAttribute("data-status-filter", "all");
        else if (index === 1)
          card.setAttribute("data-status-filter", "pending,in_review");
        else if (index === 2)
          card.setAttribute("data-status-filter", "completed");

        card.addEventListener("click", (e) => {
          document
            .querySelectorAll(".stat-card")
            .forEach((c) => c.classList.remove("active"));
          e.currentTarget.classList.add("active");
          currentAppraisalPage = 1;
          currentStatusFilter = e.currentTarget.dataset.statusFilter;
          fetchMyPageData(currentAppraisalPage);
        });
      });

      async function handleSubscriptionAction() {
        const button = document.getElementById("btn-manage-subscription");
        if (button.textContent === "구독 관리") {
          alert("구독 관리 기능은 준비 중입니다.");
          return;
        }

        // '구독 신청하기' 로직
        const productInfo = {
          product_type: "quicklink_subscription",
          product_name: "퀵링크 월간 구독 (10회)",
          amount: 29000,
        };
        try {
          button.textContent = "처리중...";
          button.disabled = true;
          const prepResponse = await fetch("/api/appr/payments/prepare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(productInfo),
            credentials: "include",
          });
          const prepData = await prepResponse.json();
          if (prepData.success && prepData.paramsForNicePaySDK) {
            if (
              typeof AUTHNICE !== "undefined" &&
              typeof AUTHNICE.requestPay === "function"
            ) {
              AUTHNICE.requestPay({
                ...prepData.paramsForNicePaySDK,
                fnError: function (result) {
                  alert("결제창 오류 또는 사용자 취소: " + result.errorMsg);
                  button.textContent = "구독 신청하기";
                  button.disabled = false;
                },
              });
            } else {
              alert("나이스페이 결제 모듈(AUTHNICE)을 로드할 수 없습니다.");
              button.textContent = "구독 신청하기";
              button.disabled = false;
            }
          } else {
            alert("결제 준비 실패: " + (prepData.message || "알 수 없는 오류"));
            button.textContent = "구독 신청하기";
            button.disabled = false;
          }
        } catch (err) {
          alert("결제 준비 중 오류: " + err.message);
          button.textContent = "구독 신청하기";
          button.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchMyPageData(currentAppraisalPage);
        function handleResponsiveLayout() {
          const navDesktop = document.querySelector(".nav-desktop");
          const mobileMenuBtn = document.querySelector(".mobile-menu-btn");
          if (window.innerWidth >= 768) {
            if (navDesktop) navDesktop.style.display = "flex";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "none";
            if (document.getElementById("mobile-menu"))
              document.getElementById("mobile-menu").style.display = "none";
          } else {
            if (navDesktop) navDesktop.style.display = "none";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "block";
          }
        }
        handleResponsiveLayout();
        window.addEventListener("resize", handleResponsiveLayout);
      });
    </script>
    <!-- 나이스페이 JS SDK는 공통 레이아웃에 한 번만 포함하거나, 필요시 여기에 추가 -->
    <script src="https://pay.nicepay.co.kr/v1/js/"></script>
  </body>
</html>
