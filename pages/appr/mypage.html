<!-- pages/appr/mypage.html -->
<!-- ë§ˆì´í˜ì´ì§€ -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì´í˜ì´ì§€ - CAS ëª…í’ˆê°ì •ì‹œìŠ¤í…œ</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Montserrat:wght@500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      /* ê¸°ë³¸ ë¦¬ì…‹ ë° í°íŠ¸ ì„¤ì • */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
      }

      body {
        color: #1a2a3a;
        line-height: 1.6;
        background-color: #f8fafc;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* í—¤ë” & í‘¸í„° ê³µí†µ ìŠ¤íƒ€ì¼ */
      header {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 0;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 40px;
      }

      .logo {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1a2a3a;
        text-decoration: none;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
      }

      .logo .cas-highlight {
        background: linear-gradient(135deg, #1a2a3a 0%, #2d4263 100%);
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-desktop {
        display: none;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        justify-content: flex-end;
      }

      .nav-desktop a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        white-space: nowrap;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      .nav-desktop a:hover {
        color: #666;
        background-color: rgba(0, 0, 0, 0.05);
      }

      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .mobile-menu {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: #fff;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      }

      .mobile-menu a {
        display: block;
        padding: 15px 20px;
        color: #4a5568;
        text-decoration: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .mobile-menu a:last-child {
        border-bottom: none;
      }

      @media (min-width: 768px) {
        .nav-desktop {
          display: flex !important;
          gap: 8px;
        }
        .mobile-menu-btn {
          display: none !important;
        }
      }

      @media (min-width: 1024px) {
        .nav-desktop {
          gap: 12px;
        }
        .nav-desktop a {
          padding: 8px 16px;
          font-size: 1rem;
        }
      }

      .btn-primary {
        background-color: #1a2a3a;
        color: #fff;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-primary:hover {
        background-color: #2d4263;
      }

      .btn-outline {
        background-color: transparent;
        color: #1a2a3a;
        padding: 12px 24px;
        border: 1px solid #1a2a3a;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-outline:hover {
        background-color: rgba(26, 42, 58, 0.05);
      }

      /* íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
      .tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .tab {
        padding: 12px 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
        border-bottom: 2px solid transparent;
      }

      .tab:hover {
        color: #1a2a3a;
      }

      .tab.active {
        color: #1a2a3a;
        border-bottom-color: #1a2a3a;
      }

      /* ë§ˆì´í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
      .user-profile {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        gap: 20px;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #64748b;
      }

      .user-info h2 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .user-info p {
        color: #64748b;
      }

      .stats {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        flex: 1;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
      }

      .stat-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card.active {
        border: 2px solid #1a2a3a;
      }

      .stat-card h3 {
        font-size: 1rem;
        color: #64748b;
        margin-bottom: 8px;
      }

      .stat-card .number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1a2a3a;
      }

      .appraisal-list {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .appraisal-item {
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s;
      }

      .appraisal-item:last-child {
        border-bottom: none;
      }

      .appraisal-item:hover {
        background-color: #f1f5f9;
      }

      .appraisal-item-image {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
      }

      .appraisal-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .appraisal-item-content {
        flex: 1;
      }

      .appraisal-item-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .appraisal-item-details {
        font-size: 0.9rem;
        color: #64748b;
      }

      .appraisal-item-action {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #e2e8f0;
        color: #1a2a3a;
        text-decoration: none;
      }

      .appraisal-item-action:hover {
        background-color: #cbd5e1;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 8px;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #059669;
      }
      .badge-error {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .badge-warning {
        background-color: #fef3c7;
        color: #d97706;
      }
      .badge-pending {
        background-color: #e0e7ff;
        color: #4338ca;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 8px;
      }
      .pagination-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
        border: none;
        background-color: transparent;
      }
      .pagination-item:hover {
        background-color: #e2e8f0;
      }
      .pagination-item.active {
        background-color: #1a2a3a;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
      }
      .empty-state-icon {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 15px;
      }
      .empty-state-message {
        color: #64748b;
        font-size: 1.1rem;
        margin-bottom: 20px;
      }
      /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
      .loading {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #64748b;
      }
      /* ë©¤ë²„ì‹­ ë°°ì§€ ìŠ¤íƒ€ì¼ */
      .membership-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .badge-casatrade {
        background-color: #e0f2fe;
        color: #0369a1;
      }
      .badge-partner {
        background-color: #f0fdf4;
        color: #16a34a;
      }
      .badge-regular {
        background-color: #f1f5f9;
        color: #475569;
      }
      .badge-subscribed {
        background-color: #d1fae5;
        color: #059669;
      }
      .badge-unsubscribed {
        background-color: #fee2e2;
        color: #dc2626;
      }
      /* íŒì—… ìŠ¤íƒ€ì¼ */
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .popup.show {
        display: flex;
        opacity: 1;
        visibility: visible;
      }
      .popup-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 90%;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #aaa;
      }
      .popup-close:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-inner">
          <div class="header-left">
            <a href="/appr" class="logo">
              <img
                src="https://i.ibb.co/FqJhVh0T/image.png"
                alt="CAS ëª…í’ˆê°ì •ì‹œìŠ¤í…œ"
                style="height: 40px" />
            </a>
            <nav class="nav-desktop">
              <a href="/appr">í™ˆ</a>
              <a href="/appr/request">ê°ì •ì‹ ì²­</a>
              <a href="/appr/result">ê°ì •ë²ˆí˜¸ì¡°íšŒ</a>
              <a href="/appr/mypage">ë§ˆì´í˜ì´ì§€</a>
              <a href="/appr/repair">ê¹Œì‚¬ë³µì›ì‹œìŠ¤í…œ</a>
              <a href="/appr/authenticity">ì •ê°€í’ˆêµ¬ë³„ë²•</a>
              <a href="/appr/signin">ë¡œê·¸ì¸</a>
            </nav>
          </div>
          <button
            class="mobile-menu-btn"
            id="menu-icon"
            onclick="toggleMobileMenu()">
            â˜°
          </button>
        </div>
      </div>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="/appr">í™ˆ</a>
      <a href="/appr/request">ê°ì •ì‹ ì²­</a>
      <a href="/appr/result">ê°ì •ë²ˆí˜¸ì¡°íšŒ</a>
      <a href="/appr/mypage">ë§ˆì´í˜ì´ì§€</a>
      <a href="/appr/repair">ê¹Œì‚¬ë³µì›ì‹œìŠ¤í…œ</a>
      <a href="/appr/authenticity">ì •ê°€í’ˆêµ¬ë³„ë²•</a>
      <a href="/appr/signin">ë¡œê·¸ì¸</a>
    </div>

    <main>
      <section style="padding: 50px 0">
        <div class="container">
          <div class="user-profile">
            <div class="user-avatar" id="user-avatar-initial">ğŸ‘¤</div>
            <div class="user-info">
              <h2 id="user-name-display">ë¡œë”© ì¤‘...</h2>
              <p>ê°€ì…ì¼: <span id="join-date-display">-</span></p>
            </div>
          </div>

          <div
            style="
              background-color: #fff;
              border-radius: 8px;
              padding: 25px;
              margin-bottom: 30px;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            ">
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 30px;
                align-items: flex-end;
              ">
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  íšŒì›ë“±ê¸‰
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="membership-tier-badge"
                    class="membership-badge badge-regular"
                    style="margin-right: 10px"
                    >ì¼ë°˜íšŒì›</span
                  >
                  <a
                    href="#"
                    onclick="showMembershipInfo(); return false;"
                    style="
                      font-size: 0.85rem;
                      color: #64748b;
                      text-decoration: underline;
                    "
                    >ë“±ê¸‰ í˜œíƒ ë³´ê¸°</a
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  í€µë§í¬ ê°ì • í¬ë ˆë”§
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="quicklink-credit-value"
                    style="
                      font-size: 1.25rem;
                      font-weight: 700;
                      color: #1a2a3a;
                      margin-right: 5px;
                    "
                    >0íšŒ</span
                  >
                  <span
                    id="quicklink-limit-text"
                    style="color: #64748b; font-size: 0.9rem"
                    >/ ì›” 0íšŒ</span
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  êµ¬ë… ìƒíƒœ
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="subscription-status-badge"
                    class="membership-badge badge-unsubscribed"
                    style="margin-right: 10px"
                    >ë¯¸êµ¬ë…</span
                  >
                  <button
                    id="btn-manage-subscription"
                    class="btn-primary"
                    style="padding: 6px 10px; font-size: 0.8rem"
                    onclick="handleSubscriptionAction()">
                    êµ¬ë… ì‹ ì²­í•˜ê¸°
                  </button>
                </div>
              </div>
            </div>
            <p
              style="
                font-size: 0.9rem;
                color: #64748b;
                margin-top: 15px;
                border-top: 1px solid #e2e8f0;
                padding-top: 15px;
              ">
              * í€µë§í¬ ê°ì • í¬ë ˆë”§ì€ ë§¤ì›” 1ì¼ì— ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br />
              * ì •í’ˆ ë˜ëŠ” ê°€í’ˆìœ¼ë¡œ íŒì •ëœ ê²½ìš°ì—ë§Œ í¬ë ˆë”§ì´ ì°¨ê°ë˜ë©°,
              ìë£Œë¶€ì¡±ìœ¼ë¡œ íŒì •ëœ ê²½ìš°ëŠ” ì°¨ê°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
          </div>

          <div class="stats">
            <div
              class="stat-card active"
              data-status-filter="all"
              onclick="filterAppraisals('all', this)">
              <h3>ì´ ê°ì •ìš”ì²­</h3>
              <div class="number" id="stat-total-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              data-status-filter="pending,in_review"
              onclick="filterAppraisals('pending,in_review', this)">
              <h3>ê°ì •ì¤‘</h3>
              <div class="number" id="stat-pending-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              data-status-filter="completed"
              onclick="filterAppraisals('completed', this)">
              <h3>ê°ì •ì™„ë£Œ</h3>
              <div class="number" id="stat-completed-appraisals">0</div>
            </div>
          </div>

          <div class="appraisal-list">
            <div id="appraisal-list-items">
              <div class="loading">ê°ì • ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div class="pagination" id="appraisal-pagination"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- ë“±ê¸‰ í˜œíƒ íŒì—… -->
    <div id="membership-info-popup" class="popup">
      <div class="popup-content">
        <span class="popup-close" onclick="closePopup('membership-info-popup')"
          >âœ•</span
        >
        <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 20px">
          íšŒì›ë“±ê¸‰ í˜œíƒ ì•ˆë‚´
        </h3>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            ê¹Œì‚¬íŠ¸ë ˆì´ë“œ íšŒì›
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>í€µë§í¬ ê°ì • êµ¬ë… ë¬´ë£Œ</li>
            <li>ì›” 10íšŒ í€µë§í¬ ê°ì • ì œí•œ</li>
            <li>ì˜¤í”„ë¼ì¸ ì‹¤ë¬¼ê°ì • 38,000ì› â†’ <strong>12,000ì›</strong></li>
          </ul>
        </div>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            ì œíœ´ì‚¬ íšŒì›
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>í€µë§í¬ ê°ì • êµ¬ë… ë¬´ë£Œ</li>
            <li>ì›” 5íšŒ í€µë§í¬ ê°ì • ì œí•œ</li>
            <li>ì˜¤í”„ë¼ì¸ ì‹¤ë¬¼ê°ì • 38,000ì› â†’ <strong>20,000ì›</strong></li>
          </ul>
        </div>
        <div style="margin-bottom: 15px">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            ì¼ë°˜íšŒì›
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>í€µë§í¬ ê°ì • êµ¬ë… ì›” 29,000ì›</li>
            <li>ì›” 10íšŒ í€µë§í¬ ê°ì • ì œí•œ</li>
            <li>ì˜¤í”„ë¼ì¸ ì‹¤ë¬¼ê°ì • 38,000ì›</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ë‚˜ì´ìŠ¤í˜ì´ JS SDK -->
    <script src="https://pay.nicepay.co.kr/v1/js/"></script>

    <script>
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobile-menu");
        const menuIcon = document.getElementById("menu-icon");
        if (mobileMenu.style.display === "block") {
          mobileMenu.style.display = "none";
          if (menuIcon) menuIcon.textContent = "â˜°";
        } else {
          mobileMenu.style.display = "block";
          if (menuIcon) menuIcon.textContent = "âœ•";
        }
      }

      function showMembershipInfo() {
        document.getElementById("membership-info-popup").classList.add("show");
        document.body.style.overflow = "hidden";
      }

      function closePopup(popupId) {
        document.getElementById(popupId).classList.remove("show");
        document.body.style.overflow = "";
      }

      let currentAppraisalPage = 1;
      const appraisalsPerPage = 5; // í•œ í˜ì´ì§€ì— í‘œì‹œí•  ê°ì • ë‚´ì—­ ìˆ˜
      let currentStatusFilter = "all"; // í˜„ì¬ ì„ íƒëœ ê°ì • ìƒíƒœ í•„í„°
      let allAppraisals = []; // ì „ì²´ ê°ì • ë‚´ì—­ ì €ì¥ìš© ë³€ìˆ˜

      // ë§ˆì´í˜ì´ì§€ ë°ì´í„° ë¡œë“œ
      async function fetchMyPageData() {
        try {
          // ì‚¬ìš©ì í”„ë¡œí•„ ë° ë©¤ë²„ì‹­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const profileResponse = await fetch("/api/appr/users/profile", {
            credentials: "include",
          });

          if (!profileResponse.ok) {
            if (profileResponse.status === 401) {
              window.location.href = "/appr/signin";
              return;
            }
            throw new Error(
              "í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: " + profileResponse.statusText
            );
          }

          const profileData = await profileResponse.json();

          if (profileData.success) {
            updateUserProfile(profileData.user_profile);
            updateMembershipInfo(profileData.membership);
          } else {
            throw new Error(profileData.message || "í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨");
          }

          // ê°ì • ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
          await fetchAppraisals(currentAppraisalPage, currentStatusFilter);
        } catch (error) {
          console.error("ë§ˆì´í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:", error);
          document.getElementById("user-name-display").textContent =
            "ì˜¤ë¥˜ ë°œìƒ";
          document.getElementById(
            "appraisal-list-items"
          ).innerHTML = `<div class="empty-state">
              <div class="empty-state-icon">âš ï¸</div>
              <p class="empty-state-message">${
                error.message || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              }</p>
            </div>`;
        }
      }

      // ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
      function updateUserProfile(user) {
        if (!user) return;

        const nameDisplay = document.getElementById("user-name-display");
        const joinDateDisplay = document.getElementById("join-date-display");
        const avatarInitial = document.getElementById("user-avatar-initial");

        // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
        nameDisplay.textContent = `${
          user.company_name || user.email || "ê³ ê°"
        }ë‹˜`;

        // ê°€ì…ì¼ í‘œì‹œ
        if (user.created_at) {
          const joinDate = new Date(user.created_at);
          joinDateDisplay.textContent = joinDate.toLocaleDateString("ko-KR");
        }

        // ì•„ë°”íƒ€ ì´ë‹ˆì…œ ì„¤ì •
        if (user.company_name) {
          avatarInitial.textContent = user.company_name.charAt(0);
        } else if (user.email) {
          avatarInitial.textContent = user.email.charAt(0).toUpperCase();
        }
      }

      // ë©¤ë²„ì‹­ ë° êµ¬ë… ì •ë³´ ì—…ë°ì´íŠ¸
      function updateMembershipInfo(membership) {
        if (!membership) return;

        const tierBadge = document.getElementById("membership-tier-badge");
        const creditValue = document.getElementById("quicklink-credit-value");
        const creditLimitText = document.getElementById("quicklink-limit-text");
        const subscriptionBadge = document.getElementById(
          "subscription-status-badge"
        );
        const subscriptionButton = document.getElementById(
          "btn-manage-subscription"
        );

        // íšŒì› ë“±ê¸‰ í‘œì‹œ
        tierBadge.textContent = membership.tier;
        if (membership.tier === "ê¹Œì‚¬íŠ¸ë ˆì´ë“œ íšŒì›") {
          tierBadge.className = "membership-badge badge-casatrade";
        } else if (membership.tier === "ì œíœ´ì‚¬ íšŒì›") {
          tierBadge.className = "membership-badge badge-partner";
        } else {
          tierBadge.className = "membership-badge badge-regular";
        }
        // í¬ë ˆë”§ ì •ë³´ í‘œì‹œ
        creditValue.textContent = `${membership.quick_link_credits_remaining}íšŒ`;
        creditLimitText.textContent = ` / ì›” ${membership.quick_link_monthly_limit}íšŒ`;

        // êµ¬ë… ì •ë³´ í‘œì‹œ
        const isSubscribed =
          membership.quick_link_subscription_type === "paid" &&
          membership.quick_link_subscription_expires_at &&
          new Date(membership.quick_link_subscription_expires_at) > new Date();

        if (membership.tier === "ì¼ë°˜íšŒì›") {
          if (isSubscribed) {
            subscriptionBadge.textContent = "êµ¬ë…ì¤‘";
            subscriptionBadge.className = "membership-badge badge-subscribed";
            subscriptionButton.textContent = "êµ¬ë… ê´€ë¦¬";
          } else {
            subscriptionBadge.textContent = "ë¯¸êµ¬ë…";
            subscriptionBadge.className = "membership-badge badge-unsubscribed";
            subscriptionButton.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
          }
          subscriptionButton.style.display = "inline-block";
        } else {
          // ê¹Œì‚¬íŠ¸ë ˆì´ë“œ íšŒì›ì´ë‚˜ ì œíœ´ì‚¬ íšŒì›ì˜ ê²½ìš°
          subscriptionBadge.textContent = "í˜œíƒ ì ìš©ì¤‘";
          subscriptionBadge.className = "membership-badge badge-subscribed";
          subscriptionButton.style.display = "none"; // êµ¬ë… ë²„íŠ¼ ìˆ¨ê¹€
        }
      }

      // ê°ì • ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
      async function fetchAppraisals(page = 1, statusFilter = "all") {
        try {
          const listContainer = document.getElementById("appraisal-list-items");
          listContainer.innerHTML =
            '<div class="loading">ê°ì • ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

          // API í˜¸ì¶œ
          let apiUrl = `/api/appr/appraisals/my?page=${page}&limit=${appraisalsPerPage}`;
          const response = await fetch(apiUrl, { credentials: "include" });

          if (!response.ok) {
            throw new Error("ê°ì • ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨: " + response.statusText);
          }

          const data = await response.json();

          if (data.success) {
            // ê°ì • ë‚´ì—­ ì €ì¥
            allAppraisals = data.recent_appraisals.appraisals || [];

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateAppraisalStats(
              allAppraisals,
              data.recent_appraisals.pagination?.totalItems || 0
            );

            // ê°ì • ë‚´ì—­ í•„í„°ë§ ë° í‘œì‹œ
            filterAndRenderAppraisals(
              statusFilter,
              page,
              data.recent_appraisals.pagination
            );
          } else {
            throw new Error(data.message || "ê°ì • ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨");
          }
        } catch (error) {
          console.error("ê°ì • ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜:", error);
          document.getElementById(
            "appraisal-list-items"
          ).innerHTML = `<div class="empty-state">
              <div class="empty-state-icon">âš ï¸</div>
              <p class="empty-state-message">${
                error.message || "ê°ì • ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              }</p>
            </div>`;
        }
      }

      // ê°ì • ë‚´ì—­ í•„í„°ë§ ë° í‘œì‹œ
      function filterAndRenderAppraisals(statusFilter, page, pagination) {
        let filteredAppraisals = allAppraisals;

        // ìƒíƒœë³„ í•„í„°ë§
        if (statusFilter !== "all") {
          const filterStates = statusFilter.split(",");
          filteredAppraisals = allAppraisals.filter((appr) =>
            filterStates.includes(appr.status)
          );
        }

        // ê°ì • ë‚´ì—­ í‘œì‹œ
        renderAppraisalList(filteredAppraisals);

        // í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ
        renderPagination(pagination, page);
      }

      // ê°ì • í†µê³„ ì—…ë°ì´íŠ¸
      function updateAppraisalStats(appraisals, totalCount) {
        const totalEl = document.getElementById("stat-total-appraisals");
        const pendingEl = document.getElementById("stat-pending-appraisals");
        const completedEl = document.getElementById(
          "stat-completed-appraisals"
        );

        // ì „ì²´ ê°œìˆ˜
        totalEl.textContent = totalCount || appraisals.length;

        // ìƒíƒœë³„ ì¹´ìš´íŠ¸
        let pendingCount = 0;
        let completedCount = 0;

        appraisals.forEach((appr) => {
          if (appr.status === "pending" || appr.status === "in_review") {
            pendingCount++;
          } else if (appr.status === "completed") {
            completedCount++;
          }
        });

        pendingEl.textContent = pendingCount;
        completedEl.textContent = completedCount;
      }

      // ê°ì • ë‚´ì—­ í‘œì‹œ
      function renderAppraisalList(appraisals) {
        const listContainer = document.getElementById("appraisal-list-items");

        if (!appraisals || appraisals.length === 0) {
          listContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“‹</div>
              <p class="empty-state-message">í•´ë‹¹ ì¡°ê±´ì˜ ê°ì • ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = "";

        appraisals.forEach((appr) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "appraisal-item";

          // ìƒíƒœì— ë”°ë¥¸ ë°°ì§€ ì„¤ì •
          let statusText = "ì§„í–‰ì¤‘";
          let badgeClass = "badge-pending";

          if (appr.status === "completed") {
            if (appr.result === "authentic") {
              statusText = "ì •í’ˆ";
              badgeClass = "badge-success";
            } else if (appr.result === "fake") {
              statusText = "ê°€í’ˆ";
              badgeClass = "badge-error";
            } else if (appr.result === "uncertain") {
              statusText = "íŒë‹¨ë¶ˆê°€";
              badgeClass = "badge-warning";
            } else {
              statusText = "ì™„ë£Œ";
              badgeClass = "badge-success";
            }
          } else if (appr.status === "pending") {
            statusText = "ì ‘ìˆ˜ì™„ë£Œ";
          } else if (appr.status === "in_review") {
            statusText = "ê°ì •ì¤‘";
          } else if (appr.status === "cancelled") {
            statusText = "ì·¨ì†Œë¨";
            badgeClass = "badge-error";
          }

          // ê²°ê³¼ ìƒì„¸ í˜ì´ì§€ URL (certificate_number ì‚¬ìš©)
          const detailUrl = `/appr/result/${appr.certificate_number}`;

          // ì•„ì´í…œ HTML êµ¬ì„±
          itemDiv.innerHTML = `
            <div class="appraisal-item-image">
              <img src="${
                appr.images && appr.images.length > 0
                  ? appr.images[0]
                  : "https://via.placeholder.com/60x60/eee/ccc?text=NoImg"
              }" alt="ìƒí’ˆ ì´ë¯¸ì§€">
            </div>
            <div class="appraisal-item-content">
              <div class="appraisal-item-title">${appr.brand || ""} ${
            appr.model_name || ""
          }</div>
              <div class="appraisal-item-details">
                ì‹ ì²­ì¼: ${new Date(appr.created_at).toLocaleDateString(
                  "ko-KR"
                )} 
                <span class="badge ${badgeClass}">${statusText}</span>
              </div>
            </div>
            ${
              appr.status === "completed"
                ? `<a href="${detailUrl}" class="appraisal-item-action">ê²°ê³¼ ë³´ê¸°</a>`
                : `<span class="appraisal-item-action" style="cursor:default; background-color:#f1f5f9; color:#64748b;">ì§„í–‰ì¤‘</span>`
            }
          `;

          listContainer.appendChild(itemDiv);
        });
      }

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
      function renderPagination(pagination, currentPage) {
        const paginationContainer = document.getElementById(
          "appraisal-pagination"
        );
        paginationContainer.innerHTML = "";

        if (
          !pagination ||
          !pagination.totalPages ||
          pagination.totalPages <= 1
        ) {
          return;
        }

        for (let i = 1; i <= pagination.totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.className = "pagination-item";
          pageButton.textContent = i;

          if (i === currentPage) {
            pageButton.classList.add("active");
          }

          pageButton.addEventListener("click", () => {
            currentAppraisalPage = i;
            fetchAppraisals(i, currentStatusFilter);
          });

          paginationContainer.appendChild(pageButton);
        }
      }

      // ìƒíƒœ í•„í„°ë§
      function filterAppraisals(statusFilter, clickedCard) {
        // í™œì„± ì¹´ë“œ ë³€ê²½
        document.querySelectorAll(".stat-card").forEach((card) => {
          card.classList.remove("active");
        });
        clickedCard.classList.add("active");

        // í•„í„° ì ìš©
        currentStatusFilter = statusFilter;
        currentAppraisalPage = 1; // í˜ì´ì§€ ì´ˆê¸°í™”

        // ì´ë¯¸ ë¡œë“œëœ ê°ì • ë‚´ì—­ì´ ìˆìœ¼ë©´ í•„í„°ë§ë§Œ ì ìš©
        if (allAppraisals.length > 0) {
          filterAndRenderAppraisals(statusFilter, currentAppraisalPage, {
            currentPage: 1,
            totalPages: 1, // ì„ì‹œê°’, ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œ ì‘ë‹µì˜ í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´ ì‚¬ìš©
            totalItems: allAppraisals.length,
          });
        } else {
          // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
          fetchAppraisals(currentAppraisalPage, statusFilter);
        }
      }

      // êµ¬ë… ì‹ ì²­/ê´€ë¦¬ ì²˜ë¦¬
      async function handleSubscriptionAction() {
        const button = document.getElementById("btn-manage-subscription");
        const buttonText = button.textContent;

        // êµ¬ë… ê´€ë¦¬ ì•¡ì…˜
        if (buttonText === "êµ¬ë… ê´€ë¦¬") {
          alert("êµ¬ë… ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }

        // êµ¬ë… ì‹ ì²­ ì•¡ì…˜
        try {
          button.disabled = true;
          button.textContent = "ì²˜ë¦¬ ì¤‘...";

          // êµ¬ë… ì •ë³´ ìš”ì²­
          const subscriptionResponse = await fetch(
            "/api/appr/users/subscription",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ subscription_type: "monthly" }),
              credentials: "include",
            }
          );

          const subscriptionData = await subscriptionResponse.json();

          if (subscriptionData.success && subscriptionData.payment_required) {
            // ê²°ì œ ì¤€ë¹„ ìš”ì²­
            const prepareResponse = await fetch("/api/appr/payments/prepare", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                product_type: subscriptionData.payment_info.product_type,
                product_name: subscriptionData.payment_info.product_name,
                amount: subscriptionData.payment_info.amount,
              }),
              credentials: "include",
            });

            const prepareData = await prepareResponse.json();

            if (prepareData.success) {
              // ê²°ì œì°½ í˜¸ì¶œ
              AUTHNICE.requestPay({
                clientId: prepareData.paramsForNicePaySDK.clientId,
                method: "card",
                orderId: prepareData.paramsForNicePaySDK.orderId,
                amount: prepareData.paramsForNicePaySDK.amount,
                goodsName: prepareData.paramsForNicePaySDK.goodsName,
                returnUrl:
                  window.location.origin + "/api/appr/payments/approve",
                fnError: function (result) {
                  console.error("ê²°ì œ ì—ëŸ¬:", result.errorMsg);
                  alert(
                    "ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " +
                      (result.errorMsg || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
                  );
                  button.disabled = false;
                  button.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
                },
              });
            } else {
              throw new Error(
                prepareData.message || "ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              );
            }
          } else {
            throw new Error(
              subscriptionData.message ||
                "êµ¬ë… ì •ë³´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            );
          }
        } catch (error) {
          console.error("êµ¬ë… ì‹ ì²­ ì˜¤ë¥˜:", error);
          alert(error.message || "êµ¬ë… ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          button.disabled = false;
          button.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
      document.addEventListener("DOMContentLoaded", () => {
        fetchMyPageData();

        // ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ì²˜ë¦¬
        function handleResponsiveLayout() {
          const navDesktop = document.querySelector(".nav-desktop");
          const mobileMenuBtn = document.querySelector(".mobile-menu-btn");

          if (window.innerWidth >= 768) {
            if (navDesktop) navDesktop.style.display = "flex";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "none";
            const mobileMenu = document.getElementById("mobile-menu");
            if (mobileMenu) mobileMenu.style.display = "none";
          } else {
            if (navDesktop) navDesktop.style.display = "none";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "block";
          }
        }

        handleResponsiveLayout();
        window.addEventListener("resize", handleResponsiveLayout);
      });
    </script>
  </body>
</html>
