<!-- pages/appr/mypage.html -->
<!-- 마이페이지 -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>마이페이지 - CAS 명품감정시스템</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Montserrat:wght@500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      /* 기본 리셋 및 폰트 설정 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
      }

      body {
        color: #1a2a3a;
        line-height: 1.6;
        background-color: #f8fafc;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* 헤더 & 푸터 공통 스타일 */
      header {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 0;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 40px;
      }

      .logo {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1a2a3a;
        text-decoration: none;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
      }

      .logo .cas-highlight {
        background: linear-gradient(135deg, #1a2a3a 0%, #2d4263 100%);
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-desktop {
        display: none;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        justify-content: flex-end;
      }

      .nav-desktop a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        white-space: nowrap;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      .nav-desktop a:hover {
        color: #666;
        background-color: rgba(0, 0, 0, 0.05);
      }

      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .mobile-menu {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: #fff;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      }

      .mobile-menu a {
        display: block;
        padding: 15px 20px;
        color: #4a5568;
        text-decoration: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .mobile-menu a:last-child {
        border-bottom: none;
      }

      @media (min-width: 768px) {
        .nav-desktop {
          display: flex !important;
          gap: 8px;
        }
        .mobile-menu-btn {
          display: none !important;
        }
      }

      @media (min-width: 1024px) {
        .nav-desktop {
          gap: 12px;
        }
        .nav-desktop a {
          padding: 8px 16px;
          font-size: 1rem;
        }
      }

      .btn-primary {
        background-color: #1a2a3a;
        color: #fff;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-primary:hover {
        background-color: #2d4263;
      }

      .btn-outline {
        background-color: transparent;
        color: #1a2a3a;
        padding: 12px 24px;
        border: 1px solid #1a2a3a;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-outline:hover {
        background-color: rgba(26, 42, 58, 0.05);
      }

      /* 탭 메뉴 스타일 */
      .tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .tab {
        padding: 12px 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
        border-bottom: 2px solid transparent;
      }

      .tab:hover {
        color: #1a2a3a;
      }

      .tab.active {
        color: #1a2a3a;
        border-bottom-color: #1a2a3a;
      }

      /* 마이페이지 스타일 */
      .user-profile {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        gap: 20px;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #64748b;
      }

      .user-info h2 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .user-info p {
        color: #64748b;
      }

      .stats {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        flex: 1;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
      }

      .stat-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card.active {
        border: 2px solid #1a2a3a;
      }

      .stat-card h3 {
        font-size: 1rem;
        color: #64748b;
        margin-bottom: 8px;
      }

      .stat-card .number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1a2a3a;
      }

      .appraisal-list {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .appraisal-item {
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s;
      }

      .appraisal-item:last-child {
        border-bottom: none;
      }

      .appraisal-item:hover {
        background-color: #f1f5f9;
      }

      .appraisal-item-image {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
      }

      .appraisal-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .appraisal-item-content {
        flex: 1;
      }

      .appraisal-item-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .appraisal-item-details {
        font-size: 0.9rem;
        color: #64748b;
      }

      .appraisal-item-action {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #e2e8f0;
        color: #1a2a3a;
        text-decoration: none;
      }

      .appraisal-item-action:hover {
        background-color: #cbd5e1;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 8px;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #059669;
      }
      .badge-error {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .badge-warning {
        background-color: #fef3c7;
        color: #d97706;
      }
      .badge-pending {
        background-color: #e0e7ff;
        color: #4338ca;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 8px;
      }
      .pagination-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
        border: none;
        background-color: transparent;
      }
      .pagination-item:hover {
        background-color: #e2e8f0;
      }
      .pagination-item.active {
        background-color: #1a2a3a;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
      }
      .empty-state-icon {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 15px;
      }
      .empty-state-message {
        color: #64748b;
        font-size: 1.1rem;
        margin-bottom: 20px;
      }
      /* 로딩 스피너 */
      .loading {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #64748b;
      }
      /* 멤버십 배지 스타일 */
      .membership-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .badge-casatrade {
        background-color: #e0f2fe;
        color: #0369a1;
      }
      .badge-partner {
        background-color: #f0fdf4;
        color: #16a34a;
      }
      .badge-regular {
        background-color: #f1f5f9;
        color: #475569;
      }
      .badge-subscribed {
        background-color: #d1fae5;
        color: #059669;
      }
      .badge-unsubscribed {
        background-color: #fee2e2;
        color: #dc2626;
      }
      /* 팝업 스타일 */
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; /* 기본 숨김 */
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .popup.show {
        display: flex;
        opacity: 1;
        visibility: visible;
      }
      .popup-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 90%;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #aaa;
      }
      .popup-close:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-inner">
          <div class="header-left">
            <a href="/appr" class="logo">
              <img
                src="https://i.ibb.co/FqJhVh0T/image.png"
                alt="CAS 명품감정시스템"
                style="height: 40px" />
            </a>
            <nav class="nav-desktop">
              <a href="/appr">홈</a>
              <a href="/appr/request">감정신청</a>
              <a href="/appr/result">감정번호조회</a>
              <a href="/appr/mypage">마이페이지</a>
              <a href="/appr/repair">까사복원시스템</a>
              <a href="/appr/authenticity">정가품구별법</a>
              <a href="/appr/signin">로그인</a>
            </nav>
          </div>
          <button
            class="mobile-menu-btn"
            id="menu-icon"
            onclick="toggleMobileMenu()">
            ☰
          </button>
        </div>
      </div>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="/appr">홈</a>
      <a href="/appr/request">감정신청</a>
      <a href="/appr/result">감정번호조회</a>
      <a href="/appr/mypage">마이페이지</a>
      <a href="/appr/repair">까사복원시스템</a>
      <a href="/appr/authenticity">정가품구별법</a>
      <a href="/appr/signin">로그인</a>
    </div>

    <main>
      <section style="padding: 50px 0">
        <div class="container">
          <div class="user-profile">
            <div class="user-avatar" id="user-avatar-initial">👤</div>
            <div class="user-info">
              <h2 id="user-name-display">로딩 중...</h2>
              <p>가입일: <span id="join-date-display">-</span></p>
            </div>
          </div>

          <div
            style="
              background-color: #fff;
              border-radius: 8px;
              padding: 25px;
              margin-bottom: 30px;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            ">
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 30px;
                align-items: flex-end;
              ">
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  회원등급
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="membership-tier-badge"
                    class="membership-badge badge-regular"
                    style="margin-right: 10px"
                    >일반회원</span
                  >
                  <a
                    href="#"
                    onclick="showMembershipInfo(); return false;"
                    style="
                      font-size: 0.85rem;
                      color: #64748b;
                      text-decoration: underline;
                    "
                    >등급 혜택 보기</a
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  퀵링크 감정 크레딧
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="quicklink-credit-value"
                    style="
                      font-size: 1.25rem;
                      font-weight: 700;
                      color: #1a2a3a;
                      margin-right: 5px;
                    "
                    >0회</span
                  >
                  <span
                    id="quicklink-limit-text"
                    style="color: #64748b; font-size: 0.9rem"
                    >/ 월 0회</span
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  구독 상태
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="subscription-status-badge"
                    class="membership-badge badge-unsubscribed"
                    style="margin-right: 10px"
                    >미구독</span
                  >
                  <button
                    id="btn-manage-subscription"
                    class="btn-primary"
                    style="padding: 6px 10px; font-size: 0.8rem"
                    onclick="handleSubscriptionAction()">
                    구독 신청하기
                  </button>
                </div>
              </div>
            </div>
            <p
              style="
                font-size: 0.9rem;
                color: #64748b;
                margin-top: 15px;
                border-top: 1px solid #e2e8f0;
                padding-top: 15px;
              ">
              * 퀵링크 감정 크레딧은 매월 1일에 초기화됩니다.<br />
              * 정품 또는 가품으로 판정된 경우에만 크레딧이 차감되며,
              자료부족으로 판정된 경우는 차감되지 않습니다.
            </p>
          </div>

          <div class="stats">
            <div
              class="stat-card active"
              data-status-filter="all"
              onclick="filterAppraisals('all', this)">
              <h3>총 감정요청</h3>
              <div class="number" id="stat-total-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              data-status-filter="pending,in_review"
              onclick="filterAppraisals('pending,in_review', this)">
              <h3>감정중</h3>
              <div class="number" id="stat-pending-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              data-status-filter="completed"
              onclick="filterAppraisals('completed', this)">
              <h3>감정완료</h3>
              <div class="number" id="stat-completed-appraisals">0</div>
            </div>
          </div>

          <div class="appraisal-list">
            <div id="appraisal-list-items">
              <div class="loading">감정 내역을 불러오는 중...</div>
            </div>
            <div class="pagination" id="appraisal-pagination"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- 등급 혜택 팝업 -->
    <div id="membership-info-popup" class="popup">
      <div class="popup-content">
        <span class="popup-close" onclick="closePopup('membership-info-popup')"
          >✕</span
        >
        <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 20px">
          회원등급 혜택 안내
        </h3>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            까사트레이드 회원
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>퀵링크 감정 구독 무료</li>
            <li>월 10회 퀵링크 감정 제한</li>
            <li>오프라인 실물감정 38,000원 → <strong>12,000원</strong></li>
          </ul>
        </div>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            제휴사 회원
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>퀵링크 감정 구독 무료</li>
            <li>월 5회 퀵링크 감정 제한</li>
            <li>오프라인 실물감정 38,000원 → <strong>20,000원</strong></li>
          </ul>
        </div>
        <div style="margin-bottom: 15px">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            일반회원
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>퀵링크 감정 구독 월 29,000원</li>
            <li>월 10회 퀵링크 감정 제한</li>
            <li>오프라인 실물감정 38,000원</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 나이스페이 JS SDK -->
    <script src="https://pay.nicepay.co.kr/v1/js/"></script>

    <script>
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobile-menu");
        const menuIcon = document.getElementById("menu-icon");
        if (mobileMenu.style.display === "block") {
          mobileMenu.style.display = "none";
          if (menuIcon) menuIcon.textContent = "☰";
        } else {
          mobileMenu.style.display = "block";
          if (menuIcon) menuIcon.textContent = "✕";
        }
      }

      function showMembershipInfo() {
        document.getElementById("membership-info-popup").classList.add("show");
        document.body.style.overflow = "hidden";
      }

      function closePopup(popupId) {
        document.getElementById(popupId).classList.remove("show");
        document.body.style.overflow = "";
      }

      let currentAppraisalPage = 1;
      const appraisalsPerPage = 5; // 한 페이지에 표시할 감정 내역 수
      let currentStatusFilter = "all"; // 현재 선택된 감정 상태 필터
      let allAppraisals = []; // 전체 감정 내역 저장용 변수

      // 마이페이지 데이터 로드
      async function fetchMyPageData() {
        try {
          // 사용자 프로필 및 멤버십 정보 가져오기
          const profileResponse = await fetch("/api/appr/users/profile", {
            credentials: "include",
          });

          if (!profileResponse.ok) {
            if (profileResponse.status === 401) {
              window.location.href = "/appr/signin";
              return;
            }
            throw new Error(
              "프로필 정보 로드 실패: " + profileResponse.statusText
            );
          }

          const profileData = await profileResponse.json();

          if (profileData.success) {
            updateUserProfile(profileData.user_profile);
            updateMembershipInfo(profileData.membership);
          } else {
            throw new Error(profileData.message || "프로필 정보 로드 실패");
          }

          // 감정 내역 가져오기
          await fetchAppraisals(currentAppraisalPage, currentStatusFilter);
        } catch (error) {
          console.error("마이페이지 로드 오류:", error);
          document.getElementById("user-name-display").textContent =
            "오류 발생";
          document.getElementById(
            "appraisal-list-items"
          ).innerHTML = `<div class="empty-state">
              <div class="empty-state-icon">⚠️</div>
              <p class="empty-state-message">${
                error.message || "데이터를 불러오는 중 오류가 발생했습니다."
              }</p>
            </div>`;
        }
      }

      // 사용자 프로필 정보 업데이트
      function updateUserProfile(user) {
        if (!user) return;

        const nameDisplay = document.getElementById("user-name-display");
        const joinDateDisplay = document.getElementById("join-date-display");
        const avatarInitial = document.getElementById("user-avatar-initial");

        // 사용자 이름 표시
        nameDisplay.textContent = `${
          user.company_name || user.email || "고객"
        }님`;

        // 가입일 표시
        if (user.created_at) {
          const joinDate = new Date(user.created_at);
          joinDateDisplay.textContent = joinDate.toLocaleDateString("ko-KR");
        }

        // 아바타 이니셜 설정
        if (user.company_name) {
          avatarInitial.textContent = user.company_name.charAt(0);
        } else if (user.email) {
          avatarInitial.textContent = user.email.charAt(0).toUpperCase();
        }
      }

      // 멤버십 및 구독 정보 업데이트
      function updateMembershipInfo(membership) {
        if (!membership) return;

        const tierBadge = document.getElementById("membership-tier-badge");
        const creditValue = document.getElementById("quicklink-credit-value");
        const creditLimitText = document.getElementById("quicklink-limit-text");
        const subscriptionBadge = document.getElementById(
          "subscription-status-badge"
        );
        const subscriptionButton = document.getElementById(
          "btn-manage-subscription"
        );

        // 회원 등급 표시
        tierBadge.textContent = membership.tier;
        if (membership.tier === "까사트레이드 회원") {
          tierBadge.className = "membership-badge badge-casatrade";
        } else if (membership.tier === "제휴사 회원") {
          tierBadge.className = "membership-badge badge-partner";
        } else {
          tierBadge.className = "membership-badge badge-regular";
        }
        // 크레딧 정보 표시
        creditValue.textContent = `${membership.quick_link_credits_remaining}회`;
        creditLimitText.textContent = ` / 월 ${membership.quick_link_monthly_limit}회`;

        // 구독 정보 표시
        const isSubscribed =
          membership.quick_link_subscription_type === "paid" &&
          membership.quick_link_subscription_expires_at &&
          new Date(membership.quick_link_subscription_expires_at) > new Date();

        if (membership.tier === "일반회원") {
          if (isSubscribed) {
            subscriptionBadge.textContent = "구독중";
            subscriptionBadge.className = "membership-badge badge-subscribed";
            subscriptionButton.textContent = "구독 관리";
          } else {
            subscriptionBadge.textContent = "미구독";
            subscriptionBadge.className = "membership-badge badge-unsubscribed";
            subscriptionButton.textContent = "구독 신청하기";
          }
          subscriptionButton.style.display = "inline-block";
        } else {
          // 까사트레이드 회원이나 제휴사 회원의 경우
          subscriptionBadge.textContent = "혜택 적용중";
          subscriptionBadge.className = "membership-badge badge-subscribed";
          subscriptionButton.style.display = "none"; // 구독 버튼 숨김
        }
      }

      // 감정 내역 가져오기
      async function fetchAppraisals(page = 1, statusFilter = "all") {
        try {
          const listContainer = document.getElementById("appraisal-list-items");
          listContainer.innerHTML =
            '<div class="loading">감정 내역을 불러오는 중...</div>';

          // API 호출
          let apiUrl = `/api/appr/appraisals/my?page=${page}&limit=${appraisalsPerPage}`;
          const response = await fetch(apiUrl, { credentials: "include" });

          if (!response.ok) {
            throw new Error("감정 내역 로드 실패: " + response.statusText);
          }

          const data = await response.json();

          if (data.success) {
            // 감정 내역 저장
            allAppraisals = data.recent_appraisals.appraisals || [];

            // 통계 업데이트
            updateAppraisalStats(
              allAppraisals,
              data.recent_appraisals.pagination?.totalItems || 0
            );

            // 감정 내역 필터링 및 표시
            filterAndRenderAppraisals(
              statusFilter,
              page,
              data.recent_appraisals.pagination
            );
          } else {
            throw new Error(data.message || "감정 내역 로드 실패");
          }
        } catch (error) {
          console.error("감정 내역 로드 오류:", error);
          document.getElementById(
            "appraisal-list-items"
          ).innerHTML = `<div class="empty-state">
              <div class="empty-state-icon">⚠️</div>
              <p class="empty-state-message">${
                error.message || "감정 내역을 불러오는 중 오류가 발생했습니다."
              }</p>
            </div>`;
        }
      }

      // 감정 내역 필터링 및 표시
      function filterAndRenderAppraisals(statusFilter, page, pagination) {
        let filteredAppraisals = allAppraisals;

        // 상태별 필터링
        if (statusFilter !== "all") {
          const filterStates = statusFilter.split(",");
          filteredAppraisals = allAppraisals.filter((appr) =>
            filterStates.includes(appr.status)
          );
        }

        // 감정 내역 표시
        renderAppraisalList(filteredAppraisals);

        // 페이지네이션 표시
        renderPagination(pagination, page);
      }

      // 감정 통계 업데이트
      function updateAppraisalStats(appraisals, totalCount) {
        const totalEl = document.getElementById("stat-total-appraisals");
        const pendingEl = document.getElementById("stat-pending-appraisals");
        const completedEl = document.getElementById(
          "stat-completed-appraisals"
        );

        // 전체 개수
        totalEl.textContent = totalCount || appraisals.length;

        // 상태별 카운트
        let pendingCount = 0;
        let completedCount = 0;

        appraisals.forEach((appr) => {
          if (appr.status === "pending" || appr.status === "in_review") {
            pendingCount++;
          } else if (appr.status === "completed") {
            completedCount++;
          }
        });

        pendingEl.textContent = pendingCount;
        completedEl.textContent = completedCount;
      }

      // 감정 내역 표시
      function renderAppraisalList(appraisals) {
        const listContainer = document.getElementById("appraisal-list-items");

        if (!appraisals || appraisals.length === 0) {
          listContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">📋</div>
              <p class="empty-state-message">해당 조건의 감정 내역이 없습니다.</p>
            </div>
          `;
          return;
        }

        listContainer.innerHTML = "";

        appraisals.forEach((appr) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "appraisal-item";

          // 상태에 따른 배지 설정
          let statusText = "진행중";
          let badgeClass = "badge-pending";

          if (appr.status === "completed") {
            if (appr.result === "authentic") {
              statusText = "정품";
              badgeClass = "badge-success";
            } else if (appr.result === "fake") {
              statusText = "가품";
              badgeClass = "badge-error";
            } else if (appr.result === "uncertain") {
              statusText = "판단불가";
              badgeClass = "badge-warning";
            } else {
              statusText = "완료";
              badgeClass = "badge-success";
            }
          } else if (appr.status === "pending") {
            statusText = "접수완료";
          } else if (appr.status === "in_review") {
            statusText = "감정중";
          } else if (appr.status === "cancelled") {
            statusText = "취소됨";
            badgeClass = "badge-error";
          }

          // 결과 상세 페이지 URL (certificate_number 사용)
          const detailUrl = `/appr/result/${appr.certificate_number}`;

          // 아이템 HTML 구성
          itemDiv.innerHTML = `
            <div class="appraisal-item-image">
              <img src="${
                appr.images && appr.images.length > 0
                  ? appr.images[0]
                  : "https://via.placeholder.com/60x60/eee/ccc?text=NoImg"
              }" alt="상품 이미지">
            </div>
            <div class="appraisal-item-content">
              <div class="appraisal-item-title">${appr.brand || ""} ${
            appr.model_name || ""
          }</div>
              <div class="appraisal-item-details">
                신청일: ${new Date(appr.created_at).toLocaleDateString(
                  "ko-KR"
                )} 
                <span class="badge ${badgeClass}">${statusText}</span>
              </div>
            </div>
            ${
              appr.status === "completed"
                ? `<a href="${detailUrl}" class="appraisal-item-action">결과 보기</a>`
                : `<span class="appraisal-item-action" style="cursor:default; background-color:#f1f5f9; color:#64748b;">진행중</span>`
            }
          `;

          listContainer.appendChild(itemDiv);
        });
      }

      // 페이지네이션 렌더링
      function renderPagination(pagination, currentPage) {
        const paginationContainer = document.getElementById(
          "appraisal-pagination"
        );
        paginationContainer.innerHTML = "";

        if (
          !pagination ||
          !pagination.totalPages ||
          pagination.totalPages <= 1
        ) {
          return;
        }

        for (let i = 1; i <= pagination.totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.className = "pagination-item";
          pageButton.textContent = i;

          if (i === currentPage) {
            pageButton.classList.add("active");
          }

          pageButton.addEventListener("click", () => {
            currentAppraisalPage = i;
            fetchAppraisals(i, currentStatusFilter);
          });

          paginationContainer.appendChild(pageButton);
        }
      }

      // 상태 필터링
      function filterAppraisals(statusFilter, clickedCard) {
        // 활성 카드 변경
        document.querySelectorAll(".stat-card").forEach((card) => {
          card.classList.remove("active");
        });
        clickedCard.classList.add("active");

        // 필터 적용
        currentStatusFilter = statusFilter;
        currentAppraisalPage = 1; // 페이지 초기화

        // 이미 로드된 감정 내역이 있으면 필터링만 적용
        if (allAppraisals.length > 0) {
          filterAndRenderAppraisals(statusFilter, currentAppraisalPage, {
            currentPage: 1,
            totalPages: 1, // 임시값, 실제로는 백엔드 응답의 페이지네이션 정보 사용
            totalItems: allAppraisals.length,
          });
        } else {
          // 데이터가 없으면 다시 로드
          fetchAppraisals(currentAppraisalPage, statusFilter);
        }
      }

      // 구독 신청/관리 처리
      async function handleSubscriptionAction() {
        const button = document.getElementById("btn-manage-subscription");
        const buttonText = button.textContent;

        // 구독 관리 액션
        if (buttonText === "구독 관리") {
          alert("구독 관리 기능은 준비 중입니다.");
          return;
        }

        // 구독 신청 액션
        try {
          button.disabled = true;
          button.textContent = "처리 중...";

          // 구독 정보 요청
          const subscriptionResponse = await fetch(
            "/api/appr/users/subscription",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ subscription_type: "monthly" }),
              credentials: "include",
            }
          );

          const subscriptionData = await subscriptionResponse.json();

          if (subscriptionData.success && subscriptionData.payment_required) {
            // 결제 준비 요청
            const prepareResponse = await fetch("/api/appr/payments/prepare", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                product_type: subscriptionData.payment_info.product_type,
                product_name: subscriptionData.payment_info.product_name,
                amount: subscriptionData.payment_info.amount,
              }),
              credentials: "include",
            });

            const prepareData = await prepareResponse.json();

            if (prepareData.success) {
              // 결제창 호출
              AUTHNICE.requestPay({
                clientId: prepareData.paramsForNicePaySDK.clientId,
                method: "card",
                orderId: prepareData.paramsForNicePaySDK.orderId,
                amount: prepareData.paramsForNicePaySDK.amount,
                goodsName: prepareData.paramsForNicePaySDK.goodsName,
                returnUrl:
                  window.location.origin + "/api/appr/payments/approve",
                fnError: function (result) {
                  console.error("결제 에러:", result.errorMsg);
                  alert(
                    "결제 처리 중 오류가 발생했습니다: " +
                      (result.errorMsg || "알 수 없는 오류")
                  );
                  button.disabled = false;
                  button.textContent = "구독 신청하기";
                },
              });
            } else {
              throw new Error(
                prepareData.message || "결제 준비 중 오류가 발생했습니다."
              );
            }
          } else {
            throw new Error(
              subscriptionData.message ||
                "구독 정보 요청 중 오류가 발생했습니다."
            );
          }
        } catch (error) {
          console.error("구독 신청 오류:", error);
          alert(error.message || "구독 신청 중 오류가 발생했습니다.");
          button.disabled = false;
          button.textContent = "구독 신청하기";
        }
      }

      // 페이지 로드 시 데이터 로드
      document.addEventListener("DOMContentLoaded", () => {
        fetchMyPageData();

        // 반응형 레이아웃 처리
        function handleResponsiveLayout() {
          const navDesktop = document.querySelector(".nav-desktop");
          const mobileMenuBtn = document.querySelector(".mobile-menu-btn");

          if (window.innerWidth >= 768) {
            if (navDesktop) navDesktop.style.display = "flex";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "none";
            const mobileMenu = document.getElementById("mobile-menu");
            if (mobileMenu) mobileMenu.style.display = "none";
          } else {
            if (navDesktop) navDesktop.style.display = "none";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "block";
          }
        }

        handleResponsiveLayout();
        window.addEventListener("resize", handleResponsiveLayout);
      });
    </script>
  </body>
</html>
