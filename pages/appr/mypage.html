<!-- pages/appr/mypage.html -->
<!-- ë§ˆì´í˜ì´ì§€ -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì´í˜ì´ì§€ - CAS ëª…í’ˆê°ì •ì‹œìŠ¤í…œ</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Montserrat:wght@500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      /* ê¸°ë³¸ ë¦¬ì…‹ ë° í°íŠ¸ ì„¤ì • (ì œê³µí•´ì£¼ì‹  ì›ë³¸ CSS ìœ ì§€) */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
      }

      body {
        color: #1a2a3a;
        line-height: 1.6;
        background-color: #f8fafc;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* í—¤ë” & í‘¸í„° ê³µí†µ ìŠ¤íƒ€ì¼ (ì œê³µí•´ì£¼ì‹  ì›ë³¸ CSS ìœ ì§€) */
      header {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 0;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 40px;
      }

      .logo {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1a2a3a;
        text-decoration: none;
        letter-spacing: -0.5px;
        display: flex;
        align-items: center;
      }

      .logo .cas-highlight {
        background: linear-gradient(135deg, #1a2a3a 0%, #2d4263 100%);
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-desktop {
        display: none;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        justify-content: flex-end;
      }

      .nav-desktop a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        white-space: nowrap;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      .nav-desktop a:hover {
        color: #666;
        background-color: rgba(0, 0, 0, 0.05);
      }

      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .mobile-menu {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: #fff;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        z-index: 999;
      }

      .mobile-menu a {
        display: block;
        padding: 15px 20px;
        color: #4a5568;
        text-decoration: none;
        border-bottom: 1px solid #e2e8f0;
      }

      .mobile-menu a:last-child {
        border-bottom: none;
      }

      @media (min-width: 768px) {
        .nav-desktop {
          display: flex !important;
          gap: 8px;
        }
        .mobile-menu-btn {
          display: none !important;
        }
      }

      @media (min-width: 1024px) {
        .nav-desktop {
          gap: 12px;
        }
        .nav-desktop a {
          padding: 8px 16px;
          font-size: 1rem;
        }
      }

      .btn-primary {
        background-color: #1a2a3a;
        color: #fff;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-primary:hover {
        background-color: #2d4263;
      }

      .btn-outline {
        background-color: transparent;
        color: #1a2a3a;
        padding: 12px 24px;
        border: 1px solid #1a2a3a;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .btn-outline:hover {
        background-color: rgba(26, 42, 58, 0.05);
      }

      /* íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼ (ì œê³µí•´ì£¼ì‹  ì›ë³¸ CSS ìœ ì§€) */
      .tabs {
        display: flex;
        gap: 2px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .tab {
        padding: 12px 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
        border-bottom: 2px solid transparent;
      }

      .tab:hover {
        color: #1a2a3a;
      }

      .tab.active {
        color: #1a2a3a;
        border-bottom-color: #1a2a3a;
      }

      /* ë§ˆì´í˜ì´ì§€ ìŠ¤íƒ€ì¼ (ì œê³µí•´ì£¼ì‹  ì›ë³¸ CSS ìœ ì§€) */
      .user-profile {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        gap: 20px;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #64748b;
      }

      .user-info h2 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .user-info p {
        color: #64748b;
      }

      .stats {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        flex: 1;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
      }

      .stat-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card.active {
        border: 2px solid #1a2a3a;
      }

      .stat-card h3 {
        font-size: 1rem;
        color: #64748b;
        margin-bottom: 8px;
      }

      .stat-card .number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1a2a3a;
      }

      .appraisal-list {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .appraisal-item {
        padding: 15px 0;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s;
      }

      .appraisal-item:last-child {
        border-bottom: none;
      }

      .appraisal-item:hover {
        background-color: #f1f5f9;
      }

      .appraisal-item-image {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
      }

      .appraisal-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .appraisal-item-content {
        flex: 1;
      }

      .appraisal-item-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .appraisal-item-details {
        font-size: 0.9rem;
        color: #64748b;
      }

      .appraisal-item-action {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        background-color: #e2e8f0;
        color: #1a2a3a;
        text-decoration: none;
      }

      .appraisal-item-action:hover {
        background-color: #cbd5e1;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 8px;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #059669;
      }
      .badge-error {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .badge-warning {
        background-color: #fef3c7;
        color: #d97706;
      }
      .badge-pending {
        background-color: #e0e7ff;
        color: #4338ca;
      }

      .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 8px;
      }
      .pagination-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        color: #64748b;
      }
      .pagination-item:hover {
        background-color: #e2e8f0;
      }
      .pagination-item.active {
        background-color: #1a2a3a;
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 40px 20px;
      }
      .empty-state-icon {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 15px;
      }
      .empty-state-message {
        color: #64748b;
        font-size: 1.1rem;
        margin-bottom: 20px;
      }
      /* ë¡œë”© ìŠ¤í”¼ë„ˆ (í•„ìš”ì‹œ ì¶”ê°€) */
      .loading {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #64748b;
      }
      /* íŒì—… ìŠ¤íƒ€ì¼ (ì œê³µí•´ì£¼ì‹  ì›ë³¸ CSS ìœ ì§€) */
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        align-items: center;
        justify-content: center;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .popup.show {
        display: flex;
        opacity: 1;
        visibility: visible;
      }
      .popup-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 90%;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #aaa;
      }
      .popup-close:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-inner">
          <div class="header-left">
            <a href="/appr" class="logo">
              <img
                src="https://i.ibb.co/FqJhVh0T/image.png"
                alt="CAS ëª…í’ˆê°ì •ì‹œìŠ¤í…œ"
                style="height: 40px" />
            </a>
            <nav class="nav-desktop">
              <a href="/appr">í™ˆ</a>
              <a href="/appr/request">ê°ì •ì‹ ì²­</a>
              <a href="/appr/result">ê°ì •ë²ˆí˜¸ì¡°íšŒ</a>
              <a href="/appr/mypage">ë§ˆì´í˜ì´ì§€</a>
              <a href="/appr/repair">ê¹Œì‚¬ë³µì›ì‹œìŠ¤í…œ</a>
              <a href="/appr/authenticity">ì •ê°€í’ˆêµ¬ë³„ë²•</a>
              <a href="/appr/signin">ë¡œê·¸ì¸</a>
            </nav>
          </div>
          <button
            class="mobile-menu-btn"
            id="menu-icon"
            onclick="toggleMobileMenu()">
            â˜°
          </button>
        </div>
      </div>
    </header>

    <div class="mobile-menu" id="mobile-menu">
      <a href="/appr">í™ˆ</a>
      <a href="/appr/request">ê°ì •ì‹ ì²­</a>
      <a href="/appr/result">ê°ì •ë²ˆí˜¸ì¡°íšŒ</a>
      <a href="/appr/mypage">ë§ˆì´í˜ì´ì§€</a>
      <a href="/appr/repair">ê¹Œì‚¬ë³µì›ì‹œìŠ¤í…œ</a>
      <a href="/appr/authenticity">ì •ê°€í’ˆêµ¬ë³„ë²•</a>
      <a href="/appr/signin">ë¡œê·¸ì¸</a>
    </div>

    <main>
      <section style="padding: 50px 0">
        <div class="container">
          <div class="user-profile">
            <div class="user-avatar" id="user-avatar-initial"></div>
            <div class="user-info">
              <h2 id="user-name-display">ë¡œë”© ì¤‘...</h2>
              <p>ê°€ì…ì¼: <span id="join-date-display">-</span></p>
            </div>
          </div>

          <div
            style="
              background-color: #fff;
              border-radius: 8px;
              padding: 25px;
              margin-bottom: 30px;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            ">
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 30px;
                align-items: flex-end;
              ">
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  íšŒì›ë“±ê¸‰
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="membership-badge"
                    class="badge badge-pending"
                    style="margin-right: 10px"
                    >ì •ë³´ ì—†ìŒ</span
                  >
                  <a
                    href="#"
                    onclick="showMembershipInfo(); return false;"
                    style="
                      font-size: 0.85rem;
                      color: #64748b;
                      text-decoration: underline;
                    "
                    >ë“±ê¸‰ í˜œíƒ ë³´ê¸°</a
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  í€µë§í¬ ê°ì • í¬ë ˆë”§
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="quicklink-credit"
                    style="
                      font-size: 1.25rem;
                      font-weight: 700;
                      color: #1a2a3a;
                      margin-right: 5px;
                    "
                    >0íšŒ</span
                  >
                  <span
                    id="quicklink-limit"
                    style="color: #64748b; font-size: 0.9rem"
                    >/ ì›” 0íšŒ</span
                  >
                </div>
              </div>
              <div style="flex: 1; min-width: 200px">
                <h3
                  style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    margin-bottom: 10px;
                    color: #334155;
                  ">
                  êµ¬ë… ìƒíƒœ
                </h3>
                <div style="display: flex; align-items: center">
                  <span
                    id="subscription-status"
                    class="badge badge-error"
                    style="margin-right: 10px"
                    >ë¯¸êµ¬ë…</span
                  >
                  <button
                    id="btn-manage-subscription"
                    class="btn-primary"
                    style="padding: 6px 10px; font-size: 0.8rem"
                    onclick="handleSubscriptionAction()">
                    êµ¬ë… ì‹ ì²­í•˜ê¸°
                  </button>
                </div>
              </div>
            </div>
            <p
              style="
                font-size: 0.9rem;
                color: #64748b;
                margin-top: 15px;
                border-top: 1px solid #e2e8f0;
                padding-top: 15px;
              ">
              * í€µë§í¬ ê°ì • í¬ë ˆë”§ì€ ë§¤ì›” 1ì¼ì— ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br />
              * ì •í’ˆ ë˜ëŠ” ê°€í’ˆìœ¼ë¡œ íŒì •ëœ ê²½ìš°ì—ë§Œ í¬ë ˆë”§ì´ ì°¨ê°ë˜ë©°,
              ìë£Œë¶€ì¡±ìœ¼ë¡œ íŒì •ëœ ê²½ìš°ëŠ” ì°¨ê°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
          </div>

          <div class="stats">
            <div
              class="stat-card active"
              onclick="filterAppraisals('all', this)">
              <h3>ì´ ê°ì •ìš”ì²­</h3>
              <div class="number" id="stat-total-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              onclick="filterAppraisals('pending_review,in_review', this)">
              <h3>ê°ì •ì¤‘</h3>
              <div class="number" id="stat-pending-appraisals">0</div>
            </div>
            <div
              class="stat-card"
              onclick="filterAppraisals('completed', this)">
              <h3>ê°ì •ì™„ë£Œ</h3>
              <div class="number" id="stat-completed-appraisals">0</div>
            </div>
          </div>

          <div class="appraisal-list">
            <div id="appraisal-list-items">
              <div class="loading">ê°ì • ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div class="pagination" id="appraisal-pagination"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- ë“±ê¸‰ í˜œíƒ íŒì—… (ì œê³µí•´ì£¼ì‹  ì›ë³¸ HTML êµ¬ì¡° ìœ ì§€) -->
    <div id="membership-info-popup" class="popup">
      <div class="popup-content">
        <span class="popup-close" onclick="closePopup('membership-info-popup')"
          >âœ•</span
        >
        <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 20px">
          íšŒì›ë“±ê¸‰ í˜œíƒ ì•ˆë‚´
        </h3>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            ê¹Œì‚¬íŠ¸ë ˆì´ë“œ íšŒì›
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>í€µë§í¬ ê°ì • êµ¬ë… ë¬´ë£Œ</li>
            <li>ì›” 10íšŒ í€µë§í¬ ê°ì • ì œí•œ</li>
            <li>ì˜¤í”„ë¼ì¸ ì‹¤ë¬¼ê°ì • 38,000ì› â†’ <strong>12,000ì›</strong></li>
          </ul>
        </div>
        <div
          style="
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
          ">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            ì œíœ´ì‚¬ íšŒì›
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>í€µë§í¬ ê°ì • êµ¬ë… ë¬´ë£Œ</li>
            <li>ì›” 5íšŒ í€µë§í¬ ê°ì • ì œí•œ</li>
            <li>ì˜¤í”„ë¼ì¸ ì‹¤ë¬¼ê°ì • 38,000ì› â†’ <strong>20,000ì›</strong></li>
          </ul>
        </div>
        <div style="margin-bottom: 15px">
          <h4
            style="
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: 10px;
              color: #4338ca;
            ">
            ì¼ë°˜íšŒì›
          </h4>
          <ul style="padding-left: 20px; margin-bottom: 0; color: #334155">
            <li>í€µë§í¬ ê°ì • êµ¬ë… ì›” 29,000ì›</li>
            <li>ì›” 10íšŒ í€µë§í¬ ê°ì • ì œí•œ</li>
            <li>ì˜¤í”„ë¼ì¸ ì‹¤ë¬¼ê°ì • 38,000ì›</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- ë‚˜ì´ìŠ¤í˜ì´ JS SDK (ì‹¤ì œ ê²°ì œ ì‹œ HEADë‚˜ BODY ëì— ì¶”ê°€) -->
    <!-- <script src="https://pay.nicepay.co.kr/v1/js/"></script> -->

    <script>
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobile-menu");
        const menuIcon = document.getElementById("menu-icon");
        if (mobileMenu.style.display === "block") {
          mobileMenu.style.display = "none";
          if (menuIcon) menuIcon.textContent = "â˜°";
        } else {
          mobileMenu.style.display = "block";
          if (menuIcon) menuIcon.textContent = "âœ•";
        }
      }

      function showMembershipInfo() {
        document.getElementById("membership-info-popup").classList.add("show");
        document.body.style.overflow = "hidden";
      }

      function closePopup(popupId) {
        document.getElementById(popupId).classList.remove("show");
        document.body.style.overflow = "";
      }

      let currentAppraisalPage = 1;
      const appraisalsPerPage = 5; // í•œ í˜ì´ì§€ì— í‘œì‹œí•  ê°ì • ë‚´ì—­ ìˆ˜
      let currentStatusFilter = "all"; // í˜„ì¬ ì„ íƒëœ ê°ì • ìƒíƒœ í•„í„°

      async function fetchMyPageData(page = 1, statusFilter = "all") {
        const appraisalListLoadingEl = document.getElementById(
          "appraisal-list-loading"
        );
        if (appraisalListLoadingEl)
          appraisalListLoadingEl.style.display = "block";

        try {
          let apiUrl = `/api/appr/appraisals/my?page=${page}&limit=${appraisalsPerPage}`;
          // '/my' APIëŠ” í˜„ì¬ status í•„í„°ë§ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ,
          // ë§Œì•½ ìƒíƒœë³„ í•„í„°ë§ëœ ëª©ë¡ì´ í•„ìš”í•˜ë©´ '/api/appr/appraisals'ë¥¼ ì‚¬ìš©í•˜ê³ ,
          // ì‚¬ìš©ì ì •ë³´ì™€ ë©¤ë²„ì‹­ ì •ë³´ëŠ” ë³„ë„ë¡œ ê°€ì ¸ì˜¤ê±°ë‚˜, '/my' APIë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
          // ì—¬ê¸°ì„œëŠ” '/my' APIê°€ ëª¨ë“  ì •ë³´ë¥¼ ë‹¤ ì¤€ë‹¤ê³  ê°€ì •í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§í•©ë‹ˆë‹¤.
          // ë˜ëŠ”, filterAppraisals í•¨ìˆ˜ì—ì„œ ì§ì ‘ /api/appr/appraisals?status=XXX ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
          // í˜„ì¬ëŠ” /my ì—ì„œ ë°›ì€ ì „ì²´ ëª©ë¡ì„ ê¸°ì¤€ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§í•©ë‹ˆë‹¤.

          const response = await fetch(apiUrl, { credentials: "include" });
          if (!response.ok) {
            if (response.status === 401) window.location.href = "/signinPage";
            throw new Error(
              "ë§ˆì´í˜ì´ì§€ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: " + response.statusText
            );
          }
          const data = await response.json();

          if (data.success) {
            // ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (data.user_info) {
              document.getElementById("user-name-display").textContent = `${
                data.user_info.name || "ê³ ê°"
              }ë‹˜`;
              document.getElementById("join-date-display").textContent = data
                .user_info.created_at
                ? new Date(data.user_info.created_at).toLocaleDateString()
                : "-"; // APIì— created_at ì¶”ê°€ ê°€ì •
              if (data.user_info.name) {
                document.getElementById("user-avatar-initial").textContent =
                  data.user_info.name.charAt(0);
              } else {
                document.getElementById("user-avatar-initial").textContent =
                  "ğŸ‘¤";
              }
            }

            // ë©¤ë²„ì‹­ ë° í¬ë ˆë”§ ì •ë³´ ì—…ë°ì´íŠ¸
            if (data.membership_info) {
              const tierBadge = document.getElementById(
                "membership-tier-badge"
              );
              const creditValue = document.getElementById(
                "quicklink-credit-value"
              );
              const creditLimitText = document.getElementById(
                "quicklink-limit-text"
              );
              const subscriptionBadge = document.getElementById(
                "subscription-status-badge"
              );
              const subscriptionButton = document.getElementById(
                "btn-manage-subscription"
              );

              tierBadge.textContent = data.membership_info.tier;
              if (data.membership_info.tier === "ê¹Œì‚¬íŠ¸ë ˆì´ë“œ íšŒì›")
                tierBadge.className = "membership-badge badge-casatrade";
              else if (data.membership_info.tier === "ì œíœ´ì‚¬ íšŒì›")
                tierBadge.className = "membership-badge badge-partner";
              else tierBadge.className = "membership-badge badge-regular";

              creditValue.textContent = `${data.membership_info.quick_link_credits_remaining_this_month}íšŒ`;
              creditLimitText.textContent = ` / ì›” ${data.membership_info.quick_link_credits_monthly_limit}íšŒ`;

              if (data.membership_info.tier === "ì¼ë°˜íšŒì›") {
                if (
                  data.membership_info.subscription_expires_at &&
                  new Date(data.membership_info.subscription_expires_at) >
                    new Date()
                ) {
                  subscriptionBadge.textContent = "êµ¬ë…ì¤‘";
                  subscriptionBadge.className =
                    "membership-badge badge-subscribed";
                  subscriptionButton.textContent = "êµ¬ë… ê´€ë¦¬";
                  subscriptionButton.onclick = () => {
                    alert("êµ¬ë… ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
                  };
                } else {
                  subscriptionBadge.textContent = "ë¯¸êµ¬ë…";
                  subscriptionBadge.className =
                    "membership-badge badge-unsubscribed";
                  subscriptionButton.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
                  subscriptionButton.onclick = handleSubscriptionAction;
                }
                subscriptionButton.style.display = "inline-block";
              } else {
                subscriptionBadge.textContent = "í˜œíƒ ì ìš©ì¤‘";
                subscriptionBadge.className =
                  "membership-badge badge-subscribed";
                subscriptionButton.style.display = "none";
              }
            }

            // ê°ì • ë‚´ì—­ ë° í†µê³„ ì—…ë°ì´íŠ¸
            const allAppraisals = data.recent_appraisals.appraisals || [];
            updateAppraisalStats(allAppraisals); // ì „ì²´ ëª©ë¡ ê¸°ì¤€ìœ¼ë¡œ í†µê³„ ê³„ì‚°
            filterAndRenderAppraisals(
              statusFilter,
              allAppraisals,
              page,
              data.recent_appraisals.pagination
            );
          } else {
            throw new Error(data.message || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
          }
        } catch (error) {
          console.error(error);
          document.getElementById("user-name-display").textContent = "ì˜¤ë¥˜";
          document.getElementById(
            "appraisal-list-items"
          ).innerHTML = `<p style="color:red;">${error.message}</p>`;
        } finally {
          if (appraisalListLoadingEl)
            appraisalListLoadingEl.style.display = "none";
        }
      }

      function updateAppraisalStats(appraisals) {
        let total = 0;
        let pending = 0;
        let completed = 0;

        // `/my` APIê°€ í˜ì´ì§€ë„¤ì´ì…˜ëœ ìµœê·¼ ëª©ë¡ë§Œ ì£¼ë¯€ë¡œ, ì •í™•í•œ ì „ì²´ í†µê³„ëŠ” ë³„ë„ API í•„ìš”.
        // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ë¡œë“œëœ ëª©ë¡ ê¸°ì¤€ìœ¼ë¡œë§Œ ì¹´ìš´íŠ¸.
        // ë˜ëŠ” ë°±ì—”ë“œì—ì„œ ì „ì²´ í†µê³„ë¥¼ ê°™ì´ ë‚´ë ¤ì£¼ë„ë¡ ìˆ˜ì •.
        // ì„ì‹œë¡œ, ë°±ì—”ë“œì—ì„œ ì „ì²´ totalItemsë¥¼ ë‚´ë ¤ì¤€ë‹¤ê³  ê°€ì •í•˜ê³  ì‚¬ìš©.
        fetch(`/api/appr/appraisals?limit=1`, { credentials: "include" }) // ì „ì²´ ê°œìˆ˜ íŒŒì•…ìš©
          .then((res) => res.json())
          .then((data) => {
            if (data.success && data.pagination) {
              document.getElementById("stat-total-appraisals").textContent =
                data.pagination.totalItems || 0;
            }
          });

        // ìƒíƒœë³„ ì¹´ìš´íŠ¸ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§ í•  ë•Œ ê³„ì‚°í•˜ê±°ë‚˜, ë°±ì—”ë“œê°€ ì œê³µí•´ì•¼ í•¨.
        // ì§€ê¸ˆì€ ë¡œë“œëœ ëª©ë¡ ê¸°ì¤€ìœ¼ë¡œë§Œ ê³„ì‚° (ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
        appraisals.forEach((appr) => {
          if (appr.status === "pending" || appr.status === "in_review")
            pending++;
          if (appr.status === "completed") completed++;
        });
        document.getElementById("stat-pending-appraisals").textContent =
          pending;
        document.getElementById("stat-completed-appraisals").textContent =
          completed;
      }

      function filterAndRenderAppraisals(
        statusFilter,
        allAppraisals,
        currentPage,
        paginationData
      ) {
        let filteredAppraisals = allAppraisals;
        if (statusFilter !== "all") {
          const filterStates = statusFilter.split(",");
          filteredAppraisals = allAppraisals.filter((appr) =>
            filterStates.includes(appr.status)
          );
        }
        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ ì‹œ, í˜ì´ì§€ë„¤ì´ì…˜ì€ ì „ì²´ ëª©ë¡ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°í•˜ê±°ë‚˜,
        // ì„œë²„ ì‚¬ì´ë“œ í•„í„°ë§ì„ ì‚¬ìš©í•´ì•¼ ì •í™•í•©ë‹ˆë‹¤.
        // í˜„ì¬ëŠ” `/my` APIê°€ í•„í„°ë§ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§ëœ ëª©ë¡ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
        // í˜ì´ì§€ë„¤ì´ì…˜ì€ ì„œë²„ì—ì„œ ë°›ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. (í•„í„° ì‹œ í˜ì´ì§€ë„¤ì´ì…˜ì´ ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
        renderAppraisalList(filteredAppraisals);
        renderPagination(paginationData, statusFilter); // í•„í„° ìƒíƒœ ì „ë‹¬
      }

      function renderAppraisalList(appraisals) {
        const listDiv = document.getElementById("appraisal-list-items");
        listDiv.innerHTML = "";
        if (appraisals && appraisals.length > 0) {
          appraisals.forEach((appr) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "appraisal-item";
            let resultText = appr.status;
            let resultBadgeClass = "badge-pending";
            if (appr.status === "completed") {
              if (appr.result === "authentic") {
                resultText = "ì •í’ˆ";
                resultBadgeClass = "badge-success";
              } else if (appr.result === "fake") {
                resultText = "ê°€í’ˆ";
                resultBadgeClass = "badge-error";
              } else if (appr.result === "uncertain") {
                resultText = "íŒë‹¨ë¶ˆê°€";
                resultBadgeClass = "badge-warning";
              } else {
                resultText = "ì™„ë£Œ";
                resultBadgeClass = "badge-success";
              }
            } else if (appr.status === "pending") {
              resultText = "ì ‘ìˆ˜ì™„ë£Œ";
            } else if (appr.status === "in_review") {
              resultText = "ê°ì •ì¤‘";
            } else if (appr.status === "cancelled") {
              resultText = "ì·¨ì†Œë¨";
              resultBadgeClass = "badge-error";
            }

            let detailPageUrl = `/appr/quick-result/${appr.id}`;
            // API ì‘ë‹µì— certificate_numberê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
            // if (appr.certificate_number) {
            //     detailPageUrl = `/appr/result-detail/${appr.certificate_number}`;
            // }

            itemDiv.innerHTML = `
                        <div class="appraisal-item-image">
                            <img src="${
                              appr.representative_image ||
                              "https://via.placeholder.com/60x60/eee/ccc?text=NoImg"
                            }" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                        </div>
                        <div class="appraisal-item-content">
                            <div class="appraisal-item-title">${appr.brand} ${
              appr.model_name
            }</div>
                            <div class="appraisal-item-details">
                                ì‹ ì²­ì¼: ${new Date(
                                  appr.created_at
                                ).toLocaleDateString()}
                                <span class="badge ${resultBadgeClass}">${resultText.toUpperCase()}</span>
                            </div>
                        </div>
                        ${
                          appr.status === "completed" ||
                          appr.status === "cancelled"
                            ? `<a href="${detailPageUrl}" class="appraisal-item-action">ê²°ê³¼ ë³´ê¸°</a>`
                            : `<span class="appraisal-item-action" style="cursor:default; background-color:#f1f5f9; color:#64748b;">ì§„í–‰ì¤‘</span>`
                        }
                    `;
            listDiv.appendChild(itemDiv);
          });
        } else {
          listDiv.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>í•´ë‹¹ ì¡°ê±´ì˜ ê°ì • ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
        }
      }

      function renderPagination(pagination, statusFilterForNextPage) {
        const paginationDiv = document.getElementById("appraisal-pagination");
        paginationDiv.innerHTML = "";
        if (!pagination || pagination.totalPages <= 1) return;

        for (let i = 1; i <= pagination.totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.textContent = i;
          if (i === pagination.currentPage) pageButton.classList.add("active");
          pageButton.onclick = () => {
            currentAppraisalPage = i;
            fetchMyPageData(currentAppraisalPage); // í•„í„°ëœ ëª©ë¡ì´ ì•„ë‹Œ ì „ì²´ ëª©ë¡ì˜ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜´
            // ë˜ëŠ” filterAndLoadAppraisals(statusFilterForNextPage, i) í˜¸ì¶œ
          };
          paginationDiv.appendChild(pageButton);
        }
      }

      document.querySelectorAll(".stat-card").forEach((card, index) => {
        // ì²« ë²ˆì§¸ ì¹´ë“œ: ì „ì²´, ë‘ ë²ˆì§¸ ì¹´ë“œ: ê°ì •ì¤‘, ì„¸ ë²ˆì§¸ ì¹´ë“œ: ê°ì •ì™„ë£Œ
        if (index === 0) card.setAttribute("data-status-filter", "all");
        else if (index === 1)
          card.setAttribute("data-status-filter", "pending,in_review");
        else if (index === 2)
          card.setAttribute("data-status-filter", "completed");

        card.addEventListener("click", (e) => {
          document
            .querySelectorAll(".stat-card")
            .forEach((c) => c.classList.remove("active"));
          e.currentTarget.classList.add("active");
          currentAppraisalPage = 1;
          currentStatusFilter = e.currentTarget.dataset.statusFilter;
          fetchMyPageData(currentAppraisalPage);
        });
      });

      async function handleSubscriptionAction() {
        const button = document.getElementById("btn-manage-subscription");
        if (button.textContent === "êµ¬ë… ê´€ë¦¬") {
          alert("êµ¬ë… ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }

        // 'êµ¬ë… ì‹ ì²­í•˜ê¸°' ë¡œì§
        const productInfo = {
          product_type: "quicklink_subscription",
          product_name: "í€µë§í¬ ì›”ê°„ êµ¬ë… (10íšŒ)",
          amount: 29000,
        };
        try {
          button.textContent = "ì²˜ë¦¬ì¤‘...";
          button.disabled = true;
          const prepResponse = await fetch("/api/appr/payments/prepare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(productInfo),
            credentials: "include",
          });
          const prepData = await prepResponse.json();
          if (prepData.success && prepData.paramsForNicePaySDK) {
            if (
              typeof AUTHNICE !== "undefined" &&
              typeof AUTHNICE.requestPay === "function"
            ) {
              AUTHNICE.requestPay({
                ...prepData.paramsForNicePaySDK,
                fnError: function (result) {
                  alert("ê²°ì œì°½ ì˜¤ë¥˜ ë˜ëŠ” ì‚¬ìš©ì ì·¨ì†Œ: " + result.errorMsg);
                  button.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
                  button.disabled = false;
                },
              });
            } else {
              alert("ë‚˜ì´ìŠ¤í˜ì´ ê²°ì œ ëª¨ë“ˆ(AUTHNICE)ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              button.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
              button.disabled = false;
            }
          } else {
            alert("ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨: " + (prepData.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            button.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
            button.disabled = false;
          }
        } catch (err) {
          alert("ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜: " + err.message);
          button.textContent = "êµ¬ë… ì‹ ì²­í•˜ê¸°";
          button.disabled = false;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchMyPageData(currentAppraisalPage);
        function handleResponsiveLayout() {
          const navDesktop = document.querySelector(".nav-desktop");
          const mobileMenuBtn = document.querySelector(".mobile-menu-btn");
          if (window.innerWidth >= 768) {
            if (navDesktop) navDesktop.style.display = "flex";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "none";
            if (document.getElementById("mobile-menu"))
              document.getElementById("mobile-menu").style.display = "none";
          } else {
            if (navDesktop) navDesktop.style.display = "none";
            if (mobileMenuBtn) mobileMenuBtn.style.display = "block";
          }
        }
        handleResponsiveLayout();
        window.addEventListener("resize", handleResponsiveLayout);
      });
    </script>
    <!-- ë‚˜ì´ìŠ¤í˜ì´ JS SDKëŠ” ê³µí†µ ë ˆì´ì•„ì›ƒì— í•œ ë²ˆë§Œ í¬í•¨í•˜ê±°ë‚˜, í•„ìš”ì‹œ ì—¬ê¸°ì— ì¶”ê°€ -->
    <script src="https://pay.nicepay.co.kr/v1/js/"></script>
  </body>
</html>
