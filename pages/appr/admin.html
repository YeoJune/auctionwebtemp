<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CAS 관리자 페이지</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap"
      rel="stylesheet" />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        margin: 20px;
        background-color: #f4f6f9;
      }
      .admin-container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #17a2b8;
      }
      .tab-nav {
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
      }
      .tab-nav button {
        background-color: transparent;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        margin-right: 5px;
        border-bottom: 2px solid transparent;
      }
      .tab-nav button.active {
        border-bottom-color: #17a2b8;
        color: #17a2b8;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #e9ecef;
      }
      .form-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 5px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input[type="text"],
      input[type="url"],
      input[type="number"],
      select,
      textarea {
        width: calc(100% - 22px);
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      #admin-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
      }
      .msg-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .msg-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <h1>CAS 명품감정시스템 관리자</h1>
      <div class="tab-nav">
        <button class="tab-button active" data-tab="homepage">
          홈페이지 설정
        </button>
        <button class="tab-button" data-tab="users">회원 관리</button>
        <button class="tab-button" data-tab="appraisals">감정 관리</button>
      </div>

      <div id="admin-message"></div>

      <!-- 홈페이지 설정 탭 -->
      <div id="tab-homepage" class="tab-content active">
        <h2>홈페이지 배너/통계 설정</h2>
        <form id="homepage-settings-form" class="form-section">
          <div>
            <label for="hp-banner-title">배너 제목:</label
            ><input
              type="text"
              id="hp-banner-title"
              name="homepage_banner_title" />
          </div>
          <div>
            <label for="hp-banner-subtitle">배너 부제목:</label
            ><input
              type="text"
              id="hp-banner-subtitle"
              name="homepage_banner_subtitle" />
          </div>
          <div>
            <label for="hp-banner-image-file"
              >배너 이미지 (현재: <span id="current-banner-url"></span>):</label
            ><input
              type="file"
              id="hp-banner-image-file"
              name="homepage_banner_image_file"
              accept="image/*" /><img
              id="hp-banner-preview"
              src="#"
              alt="미리보기"
              style="max-width: 200px; display: none; margin-top: 5px" />
          </div>
          <div>
            <label for="hp-btn1-text">버튼1 텍스트:</label
            ><input
              type="text"
              id="hp-btn1-text"
              name="homepage_banner_button1_text" />
          </div>
          <div>
            <label for="hp-btn1-url">버튼1 URL:</label
            ><input
              type="url"
              id="hp-btn1-url"
              name="homepage_banner_button1_url" />
          </div>
          <div>
            <label for="hp-btn2-text">버튼2 텍스트:</label
            ><input
              type="text"
              id="hp-btn2-text"
              name="homepage_banner_button2_text" />
          </div>
          <div>
            <label for="hp-btn2-url">버튼2 URL:</label
            ><input
              type="url"
              id="hp-btn2-url"
              name="homepage_banner_button2_url" />
          </div>
          <div>
            <label for="hp-show-stats">통계 표시:</label
            ><select id="hp-show-stats" name="homepage_show_stats">
              <option value="true">표시</option>
              <option value="false">숨김</option>
            </select>
          </div>
          <button type="submit">홈페이지 설정 저장</button>
        </form>
      </div>

      <!-- 회원 관리 탭 -->
      <div id="tab-users" class="tab-content">
        <h2>회원 관리</h2>
        <div class="form-section">
          <input
            type="text"
            id="user-search-keyword"
            placeholder="아이디 또는 이름으로 검색" />
          <select id="user-tier-filter">
            <option value="">등급 전체</option>
            <option value="일반회원">일반회원</option>
            <option value="제휴사 회원">제휴사 회원</option>
            <option value="까사트레이드 회원">까사트레이드 회원</option>
          </select>
          <button onclick="loadUsers()">회원 검색</button>
        </div>
        <table id="users-table">
          <thead>
            <tr>
              <th>아이디</th>
              <th>이름</th>
              <th>이메일</th>
              <th>등급</th>
              <th>잔여퀵링크</th>
              <th>활성</th>
              <th>작업</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- 회원 수정 모달/폼 필요 -->
      </div>

      <!-- 감정 관리 탭 -->
      <div id="tab-appraisals" class="tab-content">
        <h2>감정 관리</h2>
        <div class="form-section">
          <input
            type="text"
            id="appraisal-search-keyword"
            placeholder="감정ID 또는 사용자명 검색" />
          <select id="appraisal-status-filter">
            <option value="">상태 전체</option>
            <option value="pending_review">검토대기</option>
            <option value="in_review">검토중</option>
            <option value="completed">완료</option>
          </select>
          <button onclick="loadAppraisals()">감정 검색</button>
        </div>
        <table id="appraisals-table">
          <thead>
            <tr>
              <th>감정ID</th>
              <th>사용자</th>
              <th>브랜드</th>
              <th>모델명</th>
              <th>유형</th>
              <th>상태</th>
              <th>결과</th>
              <th>신청일</th>
              <th>작업</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <!-- 감정 결과 입력 모달/폼 필요 -->
      </div>
    </div>

    <script>
      const adminMessageDiv = document.getElementById("admin-message");

      function showAdminMessage(message, type = "error") {
        adminMessageDiv.textContent = message;
        adminMessageDiv.className =
          type === "success" ? "msg-success" : "msg-error";
      }

      // 탭 기능
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabContents = document.querySelectorAll(".tab-content");
      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));
          button.classList.add("active");
          document
            .getElementById("tab-" + button.dataset.tab)
            .classList.add("active");
        });
      });

      // 홈페이지 설정
      const hpForm = document.getElementById("homepage-settings-form");
      const currentBannerUrlSpan =
        document.getElementById("current-banner-url");
      const bannerPreviewImg = document.getElementById("hp-banner-preview");

      async function loadHomepageSettings() {
        try {
          const res = await fetch("/api/appr-admin/settings/homepage");
          const data = await res.json();
          if (data.success) {
            document.getElementById("hp-banner-title").value =
              data.settings.homepage_banner_title || "";
            document.getElementById("hp-banner-subtitle").value =
              data.settings.homepage_banner_subtitle || "";
            currentBannerUrlSpan.textContent =
              data.settings.homepage_banner_image_url || "없음";
            if (data.settings.homepage_banner_image_url)
              bannerPreviewImg.src = data.settings.homepage_banner_image_url;
            bannerPreviewImg.style.display = data.settings
              .homepage_banner_image_url
              ? "block"
              : "none";
            document.getElementById("hp-btn1-text").value =
              data.settings.homepage_banner_button1_text || "";
            document.getElementById("hp-btn1-url").value =
              data.settings.homepage_banner_button1_url || "";
            document.getElementById("hp-btn2-text").value =
              data.settings.homepage_banner_button2_text || "";
            document.getElementById("hp-btn2-url").value =
              data.settings.homepage_banner_button2_url || "";
            document.getElementById("hp-show-stats").value =
              data.settings.homepage_show_stats || "true";
          } else {
            showAdminMessage("설정 로드 실패: " + data.message);
          }
        } catch (err) {
          showAdminMessage("설정 로드 오류: " + err.message);
        }
      }
      document.getElementById("hp-banner-image-file").onchange = (evt) => {
        const [file] = evt.target.files;
        if (file) {
          bannerPreviewImg.src = URL.createObjectURL(file);
          bannerPreviewImg.style.display = "block";
        }
      };
      hpForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(hpForm);
        showAdminMessage("저장 중...", "success");
        try {
          const res = await fetch("/api/appr-admin/settings/homepage", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();
          if (result.success) {
            showAdminMessage("홈페이지 설정 저장 완료.", "success");
            if (result.newImageUrl) {
              // 새 이미지 업로드 시 미리보기 업데이트
              currentBannerUrlSpan.textContent = result.newImageUrl;
              bannerPreviewImg.src = result.newImageUrl;
            }
          } else {
            showAdminMessage("저장 실패: " + result.message);
          }
        } catch (err) {
          showAdminMessage("저장 오류: " + err.message);
        }
      });

      // 회원 관리 (목록 로드, 수정 기능 등은 유사한 방식으로 API 호출하여 구현)
      async function loadUsers() {
        const keyword = document.getElementById("user-search-keyword").value;
        const tier = document.getElementById("user-tier-filter").value;
        const usersTableBody = document.querySelector("#users-table tbody");
        usersTableBody.innerHTML =
          '<tr><td colspan="7">회원 목록 로딩 중...</td></tr>';
        try {
          const res = await fetch(
            `/api/appr-admin/users?search_keyword=${keyword}&tier_filter=${tier}`
          ); // 페이지네이션 추가 필요
          const data = await res.json();
          usersTableBody.innerHTML = "";
          if (data.success && data.users) {
            if (data.users.length === 0)
              usersTableBody.innerHTML =
                '<tr><td colspan="7">검색된 회원이 없습니다.</td></tr>';
            data.users.forEach((user) => {
              const row = usersTableBody.insertRow();
              row.innerHTML = `<td>${user.id}</td><td>${user.name}</td><td>${
                user.email
              }</td><td>${user.tier || "일반회원"}</td><td>${
                user.quick_link_allowance || 0
              }</td><td>${
                user.is_active ? "활성" : "비활성"
              }</td><td><button onclick="editUser('${
                user.id
              }')">수정</button></td>`;
            });
          } else {
            showAdminMessage("회원 목록 로드 실패: " + data.message);
          }
        } catch (err) {
          showAdminMessage("회원 목록 로드 오류: " + err.message);
          usersTableBody.innerHTML = `<tr><td colspan="7" style="color:red;">${err.message}</td></tr>`;
        }
      }
      function editUser(userId) {
        alert(
          `사용자 ID: ${userId} 수정 기능 구현 필요`
        ); /* 수정 모달/폼 표시 및 API 호출 */
      }

      // 감정 관리 (목록 로드, 결과 입력 기능 등은 유사한 방식으로 API 호출하여 구현)
      async function loadAppraisals() {
        const keyword = document.getElementById(
          "appraisal-search-keyword"
        ).value;
        const status = document.getElementById("appraisal-status-filter").value;
        const appraisalsTableBody = document.querySelector(
          "#appraisals-table tbody"
        );
        appraisalsTableBody.innerHTML =
          '<tr><td colspan="9">감정 목록 로딩 중...</td></tr>';
        try {
          const res = await fetch(
            `/api/appr-admin/appraisals?search_keyword=${keyword}&status=${status}`
          ); // 페이지네이션 추가 필요
          const data = await res.json();
          appraisalsTableBody.innerHTML = "";
          if (data.success && data.appraisals) {
            if (data.appraisals.length === 0)
              appraisalsTableBody.innerHTML =
                '<tr><td colspan="9">검색된 감정 내역이 없습니다.</td></tr>';
            data.appraisals.forEach((appr) => {
              const row = appraisalsTableBody.insertRow();
              row.innerHTML = `<td>${appr.id.slice(0, 8)}...</td><td>${
                appr.user_name
              }(${appr.user_id_display})</td><td>${appr.brand}</td><td>${
                appr.model_name
              }</td><td>${appr.appraisal_type}</td><td>${appr.status}</td><td>${
                appr.result || "-"
              }</td><td>${new Date(
                appr.created_at
              ).toLocaleDateString()}</td><td><button onclick="editAppraisalResult('${
                appr.id
              }')">결과입력</button></td>`;
            });
          } else {
            showAdminMessage("감정 목록 로드 실패: " + data.message);
          }
        } catch (err) {
          showAdminMessage("감정 목록 로드 오류: " + err.message);
          appraisalsTableBody.innerHTML = `<tr><td colspan="9" style="color:red;">${err.message}</td></tr>`;
        }
      }
      async function editAppraisalResult(appraisalId) {
        // 상세 정보 조회 API 호출 (선택적)
        // const appraisalDetail = await (await fetch(`/api/appr/appraisals/${appraisalId}`)).json(); // 관리자도 상세조회 가능해야 함
        // console.log(appraisalDetail);

        const result = prompt(
          "감정 결과를 입력하세요 (authentic, fake, uncertain):"
        );
        const notes = prompt("감정사 소견을 입력하세요:");
        if (result && notes) {
          try {
            const res = await fetch(
              `/api/appr-admin/appraisals/${appraisalId}/result`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  status: "completed",
                  result: result,
                  result_notes: notes,
                  appraiser_id: "admin",
                }),
              }
            );
            const data = await res.json();
            if (data.success) {
              showAdminMessage(
                "감정 결과가 성공적으로 업데이트되었습니다.",
                "success"
              );
              loadAppraisals(); // 목록 새로고침
            } else {
              showAdminMessage("결과 업데이트 실패: " + data.message);
            }
          } catch (err) {
            showAdminMessage("결과 업데이트 오류: " + err.message);
          }
        }
      }

      // 초기 로드
      document.addEventListener("DOMContentLoaded", () => {
        loadHomepageSettings();
        loadUsers();
        loadAppraisals();
      });
    </script>
  </body>
</html>
